name: CI/CD Pipeline - Google Cloud

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: bank-statement-analyzer-api

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:5
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      - run: npm ci
      - run: npm test
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/test-db
          REDIS_URL: redis://localhost:6379
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          ZOHO_CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          ZOHO_CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          JWT_SECRET: 6dfcdd6ab7d1ea0241b28e3fe103ccc5f7b57edfd75427a53c3e3c94c53f98bd

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
          
      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME
          echo "IMAGE_URL=$IMAGE_NAME" >> $GITHUB_ENV
          
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ env.SERVICE_NAME }}
          image: ${{ env.IMAGE_URL }}
          region: ${{ env.GCP_REGION }}
          secrets: |
            JWT_SECRET=JWT_SECRET_PROD:latest
            MONGODB_URI=MONGODB_URI_PROD:latest
            REDIS_URL=REDIS_URL_PROD:latest
            PERPLEXITY_API_KEY=PERPLEXITY_API_KEY:latest
            ZOHO_CLIENT_ID=ZOHO_CLIENT_ID:latest
            ZOHO_CLIENT_SECRET=ZOHO_CLIENT_SECRET:latest
          env_vars: |
            NODE_ENV=production
            PORT=8080
          allow_unauthenticated: false
  
function example() {
    console.log("This is a JavaScript example");
}