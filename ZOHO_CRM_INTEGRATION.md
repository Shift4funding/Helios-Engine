# Zoho CRM Critical Alerts Integration

## Overview

The Bank Statement Analyzer now automatically pushes critical alerts (HIGH and CRITICAL severity) to Zoho CRM as deal notes. This integration helps streamline the underwriting workflow by ensuring critical findings are immediately visible in your CRM system.

## Features

‚úÖ **Automatic Critical Alert Detection**: Filters alerts to include only HIGH and CRITICAL severity issues  
‚úÖ **Rich Formatted Notes**: Creates detailed, professional notes in Zoho CRM with alert summaries  
‚úÖ **Account Identification**: Each alert specifies which bank statement/account triggered it  
‚úÖ **Comprehensive Details**: Includes amounts, counts, percentages, and other relevant data  
‚úÖ **Error Resilience**: Zoho integration failures don't affect the main analysis process  
‚úÖ **Optional Integration**: Only executes when dealId is provided and Zoho is configured  

## Setup Requirements

### 1. Environment Variables

Add the following environment variables to your `.env` file:

```bash
# Zoho CRM Configuration
ZOHO_CLIENT_ID=your_zoho_client_id
ZOHO_CLIENT_SECRET=your_zoho_client_secret  
ZOHO_REFRESH_TOKEN=your_zoho_refresh_token
ZOHO_API_DOMAIN=https://www.zohoapis.com
```

### 2. Zoho CRM App Setup

1. Create a Zoho CRM application at https://api-console.zoho.com/
2. Generate OAuth credentials (Client ID, Client Secret)
3. Obtain a refresh token with CRM scope permissions
4. Ensure your Zoho CRM has the "Notes" module enabled

## API Usage

### Request Format

When calling the `/api/statements` endpoint, include an optional `dealId` parameter:

```http
POST /api/statements
Content-Type: multipart/form-data
Authorization: Bearer <token>
```

**Form Data:**
```javascript
FormData:
- statements[]: PDF files (1-4 files)
- openingBalance: "1000" (optional)
- dealId: "zoho_deal_id_here" (optional)
- applicationData: '{"businessName": "Test LLC"}' (optional)
```

### Example Request

```javascript
const formData = new FormData();
formData.append('statements', file1);
formData.append('statements', file2);
formData.append('dealId', '4876876000000568001'); // Zoho deal ID
formData.append('openingBalance', '1000');

const response = await fetch('/api/statements', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + token
  },
  body: formData
});
```

## Integration Behavior

### When Zoho Integration Triggers

The system will push alerts to Zoho CRM **only when**:

1. ‚úÖ At least one HIGH or CRITICAL alert is detected
2. ‚úÖ A valid `dealId` is provided in the request
3. ‚úÖ Zoho CRM environment variables are configured
4. ‚úÖ The analysis completes successfully

### When Zoho Integration Skips

The system will **skip** Zoho integration when:

- ‚ùå No HIGH or CRITICAL alerts found (only MEDIUM/LOW alerts)
- ‚ùå No `dealId` provided in the request
- ‚ùå Zoho CRM not configured (missing environment variables)
- ‚ùå Analysis fails before completion

## Generated Note Format

When critical alerts are found, a note like this is added to the Zoho deal:

```
üö® BANK STATEMENT ANALYSIS - CRITICAL ALERTS DETECTED
Generated: 7/19/2025, 2:15:29 PM

ALERT SUMMARY:
‚Ä¢ Critical Alerts: 1
‚Ä¢ High Priority Alerts: 2
‚Ä¢ Total Critical Issues: 3

DETAILED ALERTS:
==================================================

1. [CRITICAL] CRITICAL_NSF_ALERT
   Message: Account 1: Excessive NSF activity - 8 transactions detected
   Account: #1
   Amount: $320.50

2. [HIGH] HIGH_RISK_TRANSACTION
   Message: Account 2: Large cash withdrawal pattern detected
   Account: #2
   Amount: $5,000
   Count: 3

3. [HIGH] SUSPICIOUS_DEPOSIT_PATTERN
   Message: Account 3: Unusual deposit timing pattern detected
   Account: #3
   Count: 4

==================================================
‚ö†Ô∏è RECOMMENDED ACTION: Immediate review required for this application.
Please analyze these alerts before proceeding with underwriting decisions.

Generated by: Bank Statement Analyzer v2.0.0
```

## Response Structure

The API response remains unchanged. Zoho integration status is logged but not included in the response to maintain backward compatibility.

```json
{
  "success": true,
  "message": "Successfully analyzed 3 bank statement(s)",
  "data": {
    "summary": {
      "totalAlerts": 5,
      "alertSummary": {
        "critical": 1,
        "high": 2,
        "medium": 1,
        "low": 1
      }
    },
    "alerts": [...],
    "finsightReports": [...],
    "overallRisk": {...}
  }
}
```

## Logging

The integration provides comprehensive logging:

### Success Logs
```
‚úÖ Successfully added critical alerts note to Zoho deal 4876876000000568001
```

### Skip Logs
```
No critical alerts found for user user123 - skipping Zoho CRM update
No dealId provided for user user123 - skipping Zoho CRM update
Zoho CRM service not available - skipping critical alerts update
```

### Error Logs
```
‚ùå Failed to push critical alerts to Zoho CRM for user user123
```

## Error Handling

- **Zoho Service Errors**: Logged but don't affect main analysis
- **Network Timeouts**: Gracefully handled with detailed error messages  
- **Authentication Issues**: Clear logging for troubleshooting
- **Missing Configuration**: Warns but continues analysis

## Testing

### 1. Test Alert Filtering and Formatting

```bash
node test-zoho-alerts-integration.js
```

### 2. Test with Real PDF Files

```javascript
// Include dealId in your test request
const testData = {
  dealId: 'your_test_deal_id',
  statements: [pdfFile1, pdfFile2]
};
```

### 3. Verify in Zoho CRM

1. Upload statements with a valid dealId
2. Check the deal in Zoho CRM
3. Look for "Bank Statement Analysis Note" in the Notes section

## Configuration Examples

### Development Environment
```bash
ZOHO_CLIENT_ID=1000.ABC123DEF456
ZOHO_CLIENT_SECRET=your_dev_secret
ZOHO_REFRESH_TOKEN=1000.refresh.token.here
ZOHO_API_DOMAIN=https://www.zohoapis.com
```

### Production Environment
```bash
ZOHO_CLIENT_ID=1000.PROD123LIVE456
ZOHO_CLIENT_SECRET=your_prod_secret
ZOHO_REFRESH_TOKEN=1000.prod.refresh.token
ZOHO_API_DOMAIN=https://www.zohoapis.com
```

## Troubleshooting

### Common Issues

1. **"Zoho CRM service not available"**
   - Check environment variables are set
   - Verify Zoho credentials are valid

2. **"Failed to add note to deal"**
   - Confirm dealId exists in Zoho CRM
   - Check Zoho API permissions
   - Verify refresh token is valid

3. **No note appears in Zoho**
   - Ensure HIGH/CRITICAL alerts were detected
   - Confirm dealId was provided in request
   - Check application logs for errors

### Debug Steps

1. **Check Configuration**:
   ```bash
   echo $ZOHO_CLIENT_ID
   echo $ZOHO_CLIENT_SECRET
   echo $ZOHO_REFRESH_TOKEN
   ```

2. **Test Zoho Connectivity**:
   ```bash
   node test-crm-integration.js
   ```

3. **Monitor Logs**:
   Look for Zoho-related log messages during statement analysis

## Security Considerations

- Refresh tokens should be kept secure and rotated regularly
- Use HTTPS for all Zoho API communications
- Log sensitive operations without exposing credentials
- Consider rate limiting for Zoho API calls

## Performance Impact

- **Minimal**: Zoho integration runs asynchronously after analysis
- **Non-blocking**: Failures don't affect main analysis workflow
- **Efficient**: Only processes HIGH/CRITICAL alerts
- **Optional**: Skipped when not needed or configured

The Zoho CRM integration seamlessly enhances your underwriting workflow by ensuring critical findings are immediately accessible in your CRM system!
