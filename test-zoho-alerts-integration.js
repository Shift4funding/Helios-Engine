#!/usr/bin/env node

/**
 * Test script for Zoho CRM critical alerts integration
 * Tests the filtering and formatting of critical alerts for Zoho CRM
 */

import logger from './src/utils/logger.js';

// Mock alert data for testing
const mockAlerts = [
  {
    code: 'CRITICAL_NSF_ALERT',
    severity: 'CRITICAL',
    message: 'Account 1: Excessive NSF activity - 8 transactions detected',
    data: {
      accountIndex: 1,
      accountId: 'statement_1',
      nsfCount: 8,
      amount: 320.50
    }
  },
  {
    code: 'HIGH_RISK_TRANSACTION',
    severity: 'HIGH',
    message: 'Account 2: Large cash withdrawal pattern detected',
    data: {
      accountIndex: 2,
      accountId: 'statement_2',
      amount: 5000.00,
      count: 3
    }
  },
  {
    code: 'MEDIUM_INCOME_VARIANCE',
    severity: 'MEDIUM',
    message: 'Account 1: Income variance detected - 15% fluctuation',
    data: {
      accountIndex: 1,
      accountId: 'statement_1',
      percentage: 15
    }
  },
  {
    code: 'SUSPICIOUS_DEPOSIT_PATTERN',
    severity: 'HIGH',
    message: 'Account 3: Unusual deposit timing pattern detected',
    data: {
      accountIndex: 3,
      accountId: 'statement_3',
      count: 4
    }
  },
  {
    code: 'LOW_BALANCE_WARNING',
    severity: 'LOW',
    message: 'Account 2: Low average balance detected',
    data: {
      accountIndex: 2,
      accountId: 'statement_2',
      amount: 156.75
    }
  }
];

/**
 * Helper function to format critical alerts for Zoho CRM note
 * (Copy of the function from statementController.js for testing)
 */
const formatCriticalAlertsForZoho = (criticalAlerts) => {
  const timestamp = new Date().toLocaleString();
  const criticalCount = criticalAlerts.filter(a => a.severity === 'CRITICAL').length;
  const highCount = criticalAlerts.filter(a => a.severity === 'HIGH').length;
  
  let summary = `üö® BANK STATEMENT ANALYSIS - CRITICAL ALERTS DETECTED\n`;
  summary += `Generated: ${timestamp}\n\n`;
  summary += `ALERT SUMMARY:\n`;
  summary += `‚Ä¢ Critical Alerts: ${criticalCount}\n`;
  summary += `‚Ä¢ High Priority Alerts: ${highCount}\n`;
  summary += `‚Ä¢ Total Critical Issues: ${criticalAlerts.length}\n\n`;
  
  summary += `DETAILED ALERTS:\n`;
  summary += `${'='.repeat(50)}\n\n`;
  
  criticalAlerts.forEach((alert, index) => {
    summary += `${index + 1}. [${alert.severity}] ${alert.code}\n`;
    summary += `   Message: ${alert.message}\n`;
    
    if (alert.data) {
      if (alert.data.accountIndex) {
        summary += `   Account: #${alert.data.accountIndex}\n`;
      }
      if (alert.data.amount) {
        summary += `   Amount: $${alert.data.amount.toLocaleString()}\n`;
      }
      if (alert.data.count !== undefined) {
        summary += `   Count: ${alert.data.count}\n`;
      }
      if (alert.data.percentage) {
        summary += `   Percentage: ${alert.data.percentage}%\n`;
      }
    }
    summary += `\n`;
  });
  
  summary += `${'='.repeat(50)}\n`;
  summary += `‚ö†Ô∏è RECOMMENDED ACTION: Immediate review required for this application.\n`;
  summary += `Please analyze these alerts before proceeding with underwriting decisions.\n\n`;
  summary += `Generated by: Bank Statement Analyzer v2.0.0`;
  
  return summary;
};

/**
 * Test the critical alerts filtering and formatting
 */
const testCriticalAlertsIntegration = () => {
  try {
    console.log('üß™ Testing Zoho CRM Critical Alerts Integration\n');
    console.log('='.repeat(60));
    
    // Test 1: Filter critical alerts
    console.log('\nüìã Test 1: Filtering Critical Alerts');
    console.log('----------------------------------------');
    
    const criticalAlerts = mockAlerts.filter(alert => 
      alert.severity === 'HIGH' || alert.severity === 'CRITICAL'
    );
    
    console.log(`Total alerts: ${mockAlerts.length}`);
    console.log(`Critical alerts (HIGH/CRITICAL): ${criticalAlerts.length}`);
    console.log('Critical alerts found:');
    criticalAlerts.forEach((alert, index) => {
      console.log(`  ${index + 1}. [${alert.severity}] ${alert.code}`);
    });
    
    // Test 2: Format for Zoho
    console.log('\nüìù Test 2: Formatting for Zoho CRM');
    console.log('----------------------------------------');
    
    const formattedNote = formatCriticalAlertsForZoho(criticalAlerts);
    console.log('Formatted note preview:');
    console.log('```');
    console.log(formattedNote);
    console.log('```');
    
    // Test 3: Edge cases
    console.log('\nüîç Test 3: Edge Cases');
    console.log('----------------------------------------');
    
    // No critical alerts
    const noCriticalAlerts = mockAlerts.filter(alert => alert.severity === 'LOW');
    const filteredNoCritical = noCriticalAlerts.filter(alert => 
      alert.severity === 'HIGH' || alert.severity === 'CRITICAL'
    );
    console.log(`No critical alerts case: ${filteredNoCritical.length} alerts`);
    
    // Only CRITICAL alerts
    const onlyCritical = mockAlerts.filter(alert => alert.severity === 'CRITICAL');
    console.log(`Only CRITICAL alerts: ${onlyCritical.length} alerts`);
    
    // Only HIGH alerts
    const onlyHigh = mockAlerts.filter(alert => alert.severity === 'HIGH');
    console.log(`Only HIGH alerts: ${onlyHigh.length} alerts`);
    
    // Test 4: Validate note length
    console.log('\nüìè Test 4: Note Validation');
    console.log('----------------------------------------');
    
    const noteLength = formattedNote.length;
    console.log(`Note length: ${noteLength} characters`);
    console.log(`Note length OK: ${noteLength < 32000 ? '‚úÖ YES' : '‚ùå NO (too long)'}`);
    
    console.log('\nüéâ All tests completed successfully!');
    console.log('='.repeat(60));
    
    return true;
    
  } catch (error) {
    console.error('‚ùå Test failed:', error);
    return false;
  }
};

/**
 * Test the controller integration logic
 */
const testControllerIntegration = () => {
  console.log('\nüîß Testing Controller Integration Logic');
  console.log('='.repeat(60));
  
  // Test scenarios
  const scenarios = [
    {
      name: 'No alerts',
      alerts: [],
      dealId: 'deal123',
      expectedAction: 'Skip - no critical alerts'
    },
    {
      name: 'Critical alerts but no dealId',
      alerts: mockAlerts,
      dealId: null,
      expectedAction: 'Skip - no dealId provided'
    },
    {
      name: 'Critical alerts with dealId',
      alerts: mockAlerts,
      dealId: 'deal123',
      expectedAction: 'Push to Zoho CRM'
    },
    {
      name: 'Only medium/low alerts',
      alerts: mockAlerts.filter(a => a.severity === 'MEDIUM' || a.severity === 'LOW'),
      dealId: 'deal123',
      expectedAction: 'Skip - no critical alerts'
    }
  ];
  
  scenarios.forEach((scenario, index) => {
    console.log(`\n${index + 1}. ${scenario.name}`);
    console.log('-'.repeat(30));
    
    const criticalAlerts = scenario.alerts.filter(alert => 
      alert.severity === 'HIGH' || alert.severity === 'CRITICAL'
    );
    
    console.log(`   Total alerts: ${scenario.alerts.length}`);
    console.log(`   Critical alerts: ${criticalAlerts.length}`);
    console.log(`   Deal ID: ${scenario.dealId || 'none'}`);
    console.log(`   Expected action: ${scenario.expectedAction}`);
    
    // Simulate logic
    if (criticalAlerts.length === 0) {
      console.log(`   ‚úÖ Result: Skip - no critical alerts`);
    } else if (!scenario.dealId) {
      console.log(`   ‚úÖ Result: Skip - no dealId provided`);
    } else {
      console.log(`   ‚úÖ Result: Would push ${criticalAlerts.length} alerts to Zoho`);
    }
  });
  
  console.log('\nüéâ Controller integration test completed!');
};

// Run tests
console.log('üöÄ Starting Zoho CRM Critical Alerts Integration Tests\n');

if (testCriticalAlertsIntegration()) {
  testControllerIntegration();
  
  console.log('\n‚úÖ ALL TESTS PASSED');
  console.log('\nNext steps:');
  console.log('1. Set up Zoho CRM environment variables');
  console.log('2. Test with real PDF files and dealId parameter');
  console.log('3. Verify notes appear in Zoho CRM deals');
} else {
  console.log('\n‚ùå TESTS FAILED');
  process.exit(1);
}
