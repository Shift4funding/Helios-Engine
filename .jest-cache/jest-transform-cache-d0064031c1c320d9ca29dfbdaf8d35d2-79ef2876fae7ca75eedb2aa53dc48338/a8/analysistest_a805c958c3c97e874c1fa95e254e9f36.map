{"version":3,"names":["request","require","path","fs","promises","app","setupTestDatabase","cleanupTestDatabase","generateTestPDF","describe","testPdfPath","join","__dirname","testPdfBuffer","beforeAll","readFile","bankName","accountNumber","transactions","date","description","amount","mkdir","dirname","recursive","writeFile","afterAll","it","response","post","attach","expect","body","toMatchObject","id","any","String","businessMetrics","cashFlow","monthlyAverages","Object","stability","Number","trends","Array","riskIndicators","nsf","riskScore","operatingStats","cashReserves","metadata","analyzedAt","error","uploadResponse","analysisId","get","toHaveProperty","toBe","invalidPdfPath","stringContaining","unlink","send"],"sources":["analysis.test.js"],"sourcesContent":["const request = require('supertest');\r\nconst path = require('path');\r\nconst fs = require('fs').promises;\r\nconst app = require('../../src/app');  // Fix the path to app\r\nconst { setupTestDatabase, cleanupTestDatabase } = require('../helpers/testDb');\r\nconst { generateTestPDF } = require('../helpers/pdfGenerator');\r\n\r\ndescribe('Statement Analysis Integration', () => {\r\n    const testPdfPath = path.join(__dirname, '../fixtures/test-statement.pdf');\r\n    let testPdfBuffer;\r\n\r\n    beforeAll(async () => {\r\n        // Setup test environment\r\n        await setupTestDatabase();\r\n        \r\n        // Generate test PDF if it doesn't exist\r\n        try {\r\n            testPdfBuffer = await fs.readFile(testPdfPath);\r\n        } catch {\r\n            testPdfBuffer = await generateTestPDF({\r\n                bankName: 'Test Bank',\r\n                accountNumber: '1234567890',\r\n                transactions: [\r\n                    { date: '2025-01-01', description: 'SALARY DEPOSIT', amount: 5000 },\r\n                    { date: '2025-01-15', description: 'RENT PAYMENT', amount: -2000 },\r\n                    { date: '2025-01-31', description: 'UTILITIES', amount: -150 }\r\n                ]\r\n            });\r\n            await fs.mkdir(path.dirname(testPdfPath), { recursive: true });\r\n            await fs.writeFile(testPdfPath, testPdfBuffer);\r\n        }\r\n    });\r\n\r\n    afterAll(async () => {\r\n        await cleanupTestDatabase();\r\n    });\r\n\r\n    it('should upload PDF and return analysis', async () => {\r\n        const response = await request(app)\r\n            .post('/api/analysis/upload')\r\n            .attach('statement', testPdfPath)\r\n            .expect('Content-Type', /json/)\r\n            .expect(200);\r\n\r\n        expect(response.body).toMatchObject({\r\n            id: expect.any(String),\r\n            businessMetrics: {\r\n                cashFlow: {\r\n                    monthlyAverages: expect.any(Object),\r\n                    stability: expect.any(Number),\r\n                    trends: expect.any(Array)\r\n                },\r\n                riskIndicators: {\r\n                    nsf: expect.any(Array),\r\n                    riskScore: expect.any(Number)\r\n                },\r\n                operatingStats: expect.any(Object),\r\n                cashReserves: expect.any(Object)\r\n            },\r\n            metadata: {\r\n                analyzedAt: expect.any(String),\r\n                bankName: 'Test Bank',\r\n                accountNumber: expect.any(String)\r\n            }\r\n        });\r\n    });\r\n\r\n    it('should return 400 if no file is uploaded', async () => {\r\n        await request(app)\r\n            .post('/api/analysis/upload')\r\n            .expect(400)\r\n            .expect({\r\n                error: 'No PDF file provided'\r\n            });\r\n    });\r\n\r\n    it('should get analysis by ID', async () => {\r\n        // First upload a statement\r\n        const uploadResponse = await request(app)\r\n            .post('/api/analysis/upload')\r\n            .attach('statement', testPdfPath);\r\n\r\n        const analysisId = uploadResponse.body.id;\r\n\r\n        // Then retrieve the analysis\r\n        const response = await request(app)\r\n            .get(`/api/analysis/${analysisId}`)\r\n            .expect(200);\r\n\r\n        expect(response.body).toHaveProperty('businessMetrics');\r\n        expect(response.body.id).toBe(analysisId);\r\n    });\r\n\r\n    it('should handle invalid PDF files', async () => {\r\n        const invalidPdfPath = path.join(__dirname, '../fixtures/invalid.pdf');\r\n        await fs.writeFile(invalidPdfPath, 'Not a PDF file');\r\n\r\n        const response = await request(app)\r\n            .post('/api/analysis/upload')\r\n            .attach('statement', invalidPdfPath)\r\n            .expect(400);\r\n\r\n        expect(response.body).toMatchObject({\r\n            error: expect.stringContaining('Invalid PDF')\r\n        });\r\n\r\n        await fs.unlink(invalidPdfPath);\r\n    });\r\n\r\n    it('should analyze uploaded statement', async () => {\r\n        const response = await request(app)\r\n            .post('/api/analysis')\r\n            .send({\r\n                transactions: [\r\n                    { date: '2025-01-01', description: 'SALARY', amount: 5000 },\r\n                    { date: '2025-01-15', description: 'RENT', amount: -2000 }\r\n                ]\r\n            })\r\n            .expect(200);\r\n\r\n        expect(response.body).toMatchObject({\r\n            businessMetrics: {\r\n                cashFlow: expect.any(Object),\r\n                riskIndicators: expect.any(Object)\r\n            }\r\n        });\r\n    });\r\n});"],"mappings":"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","ignoreList":[]}