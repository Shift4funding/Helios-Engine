eb94efd128022b2f28929d42f8651212
"use strict";

class RedisRateLimiterMock {
  constructor(options) {
    this.windowMs = options.windowMs || 15 * 60 * 1000;
    this.max = options.max || 100;
    this.requests = new Map();
    this.timestamps = new Map();
  }
  middleware() {
    return async (req, res, next) => {
      const ip = req.ip;
      const now = Date.now();

      // Clean up old requests
      this.cleanupOldRequests(ip, now);

      // Get current request count
      const current = this.incrementRequests(ip);

      // Set rate limit headers
      res.setHeader('X-RateLimit-Limit', this.max);
      res.setHeader('X-RateLimit-Remaining', Math.max(0, this.max - current));
      if (current > this.max) {
        return res.status(429).json({
          error: 'Too many requests',
          retryAfter: Math.ceil(this.windowMs / 1000)
        });
      }
      next();
    };
  }
  cleanupOldRequests(ip, now) {
    const timestamps = this.timestamps.get(ip) || [];
    const validTimestamps = timestamps.filter(ts => now - ts < this.windowMs);
    this.timestamps.set(ip, validTimestamps);
    this.requests.set(ip, validTimestamps.length);
  }
  incrementRequests(ip) {
    const timestamps = this.timestamps.get(ip) || [];
    timestamps.push(Date.now());
    this.timestamps.set(ip, timestamps);
    const current = timestamps.length;
    this.requests.set(ip, current);
    return current;
  }
}
module.exports = RedisRateLimiterMock;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSZWRpc1JhdGVMaW1pdGVyTW9jayIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsIndpbmRvd01zIiwibWF4IiwicmVxdWVzdHMiLCJNYXAiLCJ0aW1lc3RhbXBzIiwibWlkZGxld2FyZSIsInJlcSIsInJlcyIsIm5leHQiLCJpcCIsIm5vdyIsIkRhdGUiLCJjbGVhbnVwT2xkUmVxdWVzdHMiLCJjdXJyZW50IiwiaW5jcmVtZW50UmVxdWVzdHMiLCJzZXRIZWFkZXIiLCJNYXRoIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwicmV0cnlBZnRlciIsImNlaWwiLCJnZXQiLCJ2YWxpZFRpbWVzdGFtcHMiLCJmaWx0ZXIiLCJ0cyIsInNldCIsImxlbmd0aCIsInB1c2giLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsicmVkaXNSYXRlTGltaXRlck1vY2suanMiXSwic291cmNlc0NvbnRlbnQiOlsiY2xhc3MgUmVkaXNSYXRlTGltaXRlck1vY2sge1xyXG4gICAgY29uc3RydWN0b3Iob3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMud2luZG93TXMgPSBvcHRpb25zLndpbmRvd01zIHx8IDE1ICogNjAgKiAxMDAwO1xyXG4gICAgICAgIHRoaXMubWF4ID0gb3B0aW9ucy5tYXggfHwgMTAwO1xyXG4gICAgICAgIHRoaXMucmVxdWVzdHMgPSBuZXcgTWFwKCk7XHJcbiAgICAgICAgdGhpcy50aW1lc3RhbXBzID0gbmV3IE1hcCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG1pZGRsZXdhcmUoKSB7XHJcbiAgICAgICAgcmV0dXJuIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpcCA9IHJlcS5pcDtcclxuICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIENsZWFuIHVwIG9sZCByZXF1ZXN0c1xyXG4gICAgICAgICAgICB0aGlzLmNsZWFudXBPbGRSZXF1ZXN0cyhpcCwgbm93KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIC8vIEdldCBjdXJyZW50IHJlcXVlc3QgY291bnRcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuaW5jcmVtZW50UmVxdWVzdHMoaXApO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgLy8gU2V0IHJhdGUgbGltaXQgaGVhZGVyc1xyXG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1MaW1pdCcsIHRoaXMubWF4KTtcclxuICAgICAgICAgICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtUmVtYWluaW5nJywgTWF0aC5tYXgoMCwgdGhpcy5tYXggLSBjdXJyZW50KSk7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBpZiAoY3VycmVudCA+IHRoaXMubWF4KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MjkpLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiAnVG9vIG1hbnkgcmVxdWVzdHMnLFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHJ5QWZ0ZXI6IE1hdGguY2VpbCgodGhpcy53aW5kb3dNcykgLyAxMDAwKVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIG5leHQoKTtcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFudXBPbGRSZXF1ZXN0cyhpcCwgbm93KSB7XHJcbiAgICAgICAgY29uc3QgdGltZXN0YW1wcyA9IHRoaXMudGltZXN0YW1wcy5nZXQoaXApIHx8IFtdO1xyXG4gICAgICAgIGNvbnN0IHZhbGlkVGltZXN0YW1wcyA9IHRpbWVzdGFtcHMuZmlsdGVyKHRzID0+IG5vdyAtIHRzIDwgdGhpcy53aW5kb3dNcyk7XHJcbiAgICAgICAgdGhpcy50aW1lc3RhbXBzLnNldChpcCwgdmFsaWRUaW1lc3RhbXBzKTtcclxuICAgICAgICB0aGlzLnJlcXVlc3RzLnNldChpcCwgdmFsaWRUaW1lc3RhbXBzLmxlbmd0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgaW5jcmVtZW50UmVxdWVzdHMoaXApIHtcclxuICAgICAgICBjb25zdCB0aW1lc3RhbXBzID0gdGhpcy50aW1lc3RhbXBzLmdldChpcCkgfHwgW107XHJcbiAgICAgICAgdGltZXN0YW1wcy5wdXNoKERhdGUubm93KCkpO1xyXG4gICAgICAgIHRoaXMudGltZXN0YW1wcy5zZXQoaXAsIHRpbWVzdGFtcHMpO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aW1lc3RhbXBzLmxlbmd0aDtcclxuICAgICAgICB0aGlzLnJlcXVlc3RzLnNldChpcCwgY3VycmVudCk7XHJcbiAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0gUmVkaXNSYXRlTGltaXRlck1vY2s7Il0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLG9CQUFvQixDQUFDO0VBQ3ZCQyxXQUFXQSxDQUFDQyxPQUFPLEVBQUU7SUFDakIsSUFBSSxDQUFDQyxRQUFRLEdBQUdELE9BQU8sQ0FBQ0MsUUFBUSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsSUFBSTtJQUNsRCxJQUFJLENBQUNDLEdBQUcsR0FBR0YsT0FBTyxDQUFDRSxHQUFHLElBQUksR0FBRztJQUM3QixJQUFJLENBQUNDLFFBQVEsR0FBRyxJQUFJQyxHQUFHLENBQUMsQ0FBQztJQUN6QixJQUFJLENBQUNDLFVBQVUsR0FBRyxJQUFJRCxHQUFHLENBQUMsQ0FBQztFQUMvQjtFQUVBRSxVQUFVQSxDQUFBLEVBQUc7SUFDVCxPQUFPLE9BQU9DLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEtBQUs7TUFDN0IsTUFBTUMsRUFBRSxHQUFHSCxHQUFHLENBQUNHLEVBQUU7TUFDakIsTUFBTUMsR0FBRyxHQUFHQyxJQUFJLENBQUNELEdBQUcsQ0FBQyxDQUFDOztNQUV0QjtNQUNBLElBQUksQ0FBQ0Usa0JBQWtCLENBQUNILEVBQUUsRUFBRUMsR0FBRyxDQUFDOztNQUVoQztNQUNBLE1BQU1HLE9BQU8sR0FBRyxJQUFJLENBQUNDLGlCQUFpQixDQUFDTCxFQUFFLENBQUM7O01BRTFDO01BQ0FGLEdBQUcsQ0FBQ1EsU0FBUyxDQUFDLG1CQUFtQixFQUFFLElBQUksQ0FBQ2QsR0FBRyxDQUFDO01BQzVDTSxHQUFHLENBQUNRLFNBQVMsQ0FBQyx1QkFBdUIsRUFBRUMsSUFBSSxDQUFDZixHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQ0EsR0FBRyxHQUFHWSxPQUFPLENBQUMsQ0FBQztNQUV2RSxJQUFJQSxPQUFPLEdBQUcsSUFBSSxDQUFDWixHQUFHLEVBQUU7UUFDcEIsT0FBT00sR0FBRyxDQUFDVSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUNDLElBQUksQ0FBQztVQUN4QkMsS0FBSyxFQUFFLG1CQUFtQjtVQUMxQkMsVUFBVSxFQUFFSixJQUFJLENBQUNLLElBQUksQ0FBRSxJQUFJLENBQUNyQixRQUFRLEdBQUksSUFBSTtRQUNoRCxDQUFDLENBQUM7TUFDTjtNQUVBUSxJQUFJLENBQUMsQ0FBQztJQUNWLENBQUM7RUFDTDtFQUVBSSxrQkFBa0JBLENBQUNILEVBQUUsRUFBRUMsR0FBRyxFQUFFO0lBQ3hCLE1BQU1OLFVBQVUsR0FBRyxJQUFJLENBQUNBLFVBQVUsQ0FBQ2tCLEdBQUcsQ0FBQ2IsRUFBRSxDQUFDLElBQUksRUFBRTtJQUNoRCxNQUFNYyxlQUFlLEdBQUduQixVQUFVLENBQUNvQixNQUFNLENBQUNDLEVBQUUsSUFBSWYsR0FBRyxHQUFHZSxFQUFFLEdBQUcsSUFBSSxDQUFDekIsUUFBUSxDQUFDO0lBQ3pFLElBQUksQ0FBQ0ksVUFBVSxDQUFDc0IsR0FBRyxDQUFDakIsRUFBRSxFQUFFYyxlQUFlLENBQUM7SUFDeEMsSUFBSSxDQUFDckIsUUFBUSxDQUFDd0IsR0FBRyxDQUFDakIsRUFBRSxFQUFFYyxlQUFlLENBQUNJLE1BQU0sQ0FBQztFQUNqRDtFQUVBYixpQkFBaUJBLENBQUNMLEVBQUUsRUFBRTtJQUNsQixNQUFNTCxVQUFVLEdBQUcsSUFBSSxDQUFDQSxVQUFVLENBQUNrQixHQUFHLENBQUNiLEVBQUUsQ0FBQyxJQUFJLEVBQUU7SUFDaERMLFVBQVUsQ0FBQ3dCLElBQUksQ0FBQ2pCLElBQUksQ0FBQ0QsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMzQixJQUFJLENBQUNOLFVBQVUsQ0FBQ3NCLEdBQUcsQ0FBQ2pCLEVBQUUsRUFBRUwsVUFBVSxDQUFDO0lBQ25DLE1BQU1TLE9BQU8sR0FBR1QsVUFBVSxDQUFDdUIsTUFBTTtJQUNqQyxJQUFJLENBQUN6QixRQUFRLENBQUN3QixHQUFHLENBQUNqQixFQUFFLEVBQUVJLE9BQU8sQ0FBQztJQUM5QixPQUFPQSxPQUFPO0VBQ2xCO0FBQ0o7QUFFQWdCLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHakMsb0JBQW9CIiwiaWdub3JlTGlzdCI6W119