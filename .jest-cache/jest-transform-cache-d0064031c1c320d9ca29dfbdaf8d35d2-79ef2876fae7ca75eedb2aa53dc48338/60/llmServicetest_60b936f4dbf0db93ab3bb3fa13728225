60d453c2128c97b1e506da4db1b13b4d
"use strict";

const mockAxios = require('jest-mock-axios').default;
const {
  LLMError
} = require('../../src/utils/errors');
const llmService = require('../../src/services/llmService');

// Mock environment variables
process.env.PERPLEXITY_API_KEY = 'test-api-key';
process.env.PERPLEXITY_API_URL = 'https://api.perplexity.ai/chat/completions';
describe('LLM Service', () => {
  beforeEach(() => {
    process.env.PERPLEXITY_API_KEY = 'test-api-key';
  });
  afterEach(() => {
    mockAxios.reset();
    jest.clearAllMocks();
  });
  describe('analyzeStatement', () => {
    const mockStatementData = {
      accountInfo: {
        accountHolder: 'John Doe',
        accountNumber: '****1234',
        statementPeriod: {
          start: '05/01/2025',
          end: '05/31/2025'
        }
      },
      transactions: [{
        date: '05/28/2025',
        description: 'PAYMENT TO XYZ',
        debit: 50.00,
        credit: null,
        balance: 950.00
      }, {
        date: '05/29/2025',
        description: 'DEPOSIT',
        debit: null,
        credit: 100.00,
        balance: 1050.00
      }]
    };
    it('should successfully analyze statement data', async () => {
      const mockLLMResponse = {
        data: {
          choices: [{
            message: {
              content: `
                                SUMMARY: Test summary
                                PATTERNS: Test patterns
                                FLAGS: No issues found
                                RECOMMENDATIONS: Save more
                            `
            }
          }]
        }
      };
      mockAxios.post.mockResolvedValueOnce(mockLLMResponse);
      const result = await llmService.analyzeStatement(mockStatementData);
      expect(result.success).toBe(true);
      expect(result.data).toHaveProperty('summary');
      expect(result.data).toHaveProperty('patterns');
    });
    it('should handle API errors gracefully', async () => {
      mockAxios.post.mockRejectedValueOnce({
        response: {
          status: 429,
          data: {
            error: 'Rate limit exceeded'
          }
        }
      });
      await expect(llmService.analyzeStatement(mockStatementData)).rejects.toThrow(LLMError);
    });
    it('should handle missing API key', async () => {
      delete process.env.PERPLEXITY_API_KEY;
      const service = require('../../src/services/llmService');
      await expect(service.analyzeStatement(mockStatementData)).rejects.toThrow('Perplexity API key not configured');
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb2NrQXhpb3MiLCJyZXF1aXJlIiwiZGVmYXVsdCIsIkxMTUVycm9yIiwibGxtU2VydmljZSIsInByb2Nlc3MiLCJlbnYiLCJQRVJQTEVYSVRZX0FQSV9LRVkiLCJQRVJQTEVYSVRZX0FQSV9VUkwiLCJkZXNjcmliZSIsImJlZm9yZUVhY2giLCJhZnRlckVhY2giLCJyZXNldCIsImplc3QiLCJjbGVhckFsbE1vY2tzIiwibW9ja1N0YXRlbWVudERhdGEiLCJhY2NvdW50SW5mbyIsImFjY291bnRIb2xkZXIiLCJhY2NvdW50TnVtYmVyIiwic3RhdGVtZW50UGVyaW9kIiwic3RhcnQiLCJlbmQiLCJ0cmFuc2FjdGlvbnMiLCJkYXRlIiwiZGVzY3JpcHRpb24iLCJkZWJpdCIsImNyZWRpdCIsImJhbGFuY2UiLCJpdCIsIm1vY2tMTE1SZXNwb25zZSIsImRhdGEiLCJjaG9pY2VzIiwibWVzc2FnZSIsImNvbnRlbnQiLCJwb3N0IiwibW9ja1Jlc29sdmVkVmFsdWVPbmNlIiwicmVzdWx0IiwiYW5hbHl6ZVN0YXRlbWVudCIsImV4cGVjdCIsInN1Y2Nlc3MiLCJ0b0JlIiwidG9IYXZlUHJvcGVydHkiLCJtb2NrUmVqZWN0ZWRWYWx1ZU9uY2UiLCJyZXNwb25zZSIsInN0YXR1cyIsImVycm9yIiwicmVqZWN0cyIsInRvVGhyb3ciLCJzZXJ2aWNlIl0sInNvdXJjZXMiOlsibGxtU2VydmljZS50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IG1vY2tBeGlvcyA9IHJlcXVpcmUoJ2plc3QtbW9jay1heGlvcycpLmRlZmF1bHQ7XHJcbmNvbnN0IHsgTExNRXJyb3IgfSA9IHJlcXVpcmUoJy4uLy4uL3NyYy91dGlscy9lcnJvcnMnKTtcclxuY29uc3QgbGxtU2VydmljZSA9IHJlcXVpcmUoJy4uLy4uL3NyYy9zZXJ2aWNlcy9sbG1TZXJ2aWNlJyk7XHJcblxyXG4vLyBNb2NrIGVudmlyb25tZW50IHZhcmlhYmxlc1xyXG5wcm9jZXNzLmVudi5QRVJQTEVYSVRZX0FQSV9LRVkgPSAndGVzdC1hcGkta2V5JztcclxucHJvY2Vzcy5lbnYuUEVSUExFWElUWV9BUElfVVJMID0gJ2h0dHBzOi8vYXBpLnBlcnBsZXhpdHkuYWkvY2hhdC9jb21wbGV0aW9ucyc7XHJcblxyXG5kZXNjcmliZSgnTExNIFNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICBwcm9jZXNzLmVudi5QRVJQTEVYSVRZX0FQSV9LRVkgPSAndGVzdC1hcGkta2V5JztcclxuICAgIH0pO1xyXG5cclxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgbW9ja0F4aW9zLnJlc2V0KCk7XHJcbiAgICAgICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnYW5hbHl6ZVN0YXRlbWVudCcsICgpID0+IHtcclxuICAgICAgICBjb25zdCBtb2NrU3RhdGVtZW50RGF0YSA9IHtcclxuICAgICAgICAgICAgYWNjb3VudEluZm86IHtcclxuICAgICAgICAgICAgICAgIGFjY291bnRIb2xkZXI6ICdKb2huIERvZScsXHJcbiAgICAgICAgICAgICAgICBhY2NvdW50TnVtYmVyOiAnKioqKjEyMzQnLFxyXG4gICAgICAgICAgICAgICAgc3RhdGVtZW50UGVyaW9kOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6ICcwNS8wMS8yMDI1JyxcclxuICAgICAgICAgICAgICAgICAgICBlbmQ6ICcwNS8zMS8yMDI1J1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB0cmFuc2FjdGlvbnM6IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRlOiAnMDUvMjgvMjAyNScsXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246ICdQQVlNRU5UIFRPIFhZWicsXHJcbiAgICAgICAgICAgICAgICAgICAgZGViaXQ6IDUwLjAwLFxyXG4gICAgICAgICAgICAgICAgICAgIGNyZWRpdDogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICBiYWxhbmNlOiA5NTAuMDBcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0ZTogJzA1LzI5LzIwMjUnLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnREVQT1NJVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgZGViaXQ6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgY3JlZGl0OiAxMDAuMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZTogMTA1MC4wMFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBzdWNjZXNzZnVsbHkgYW5hbHl6ZSBzdGF0ZW1lbnQgZGF0YScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbW9ja0xMTVJlc3BvbnNlID0ge1xyXG4gICAgICAgICAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgICAgICAgICAgIGNob2ljZXM6IFt7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGBcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTVU1NQVJZOiBUZXN0IHN1bW1hcnlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQQVRURVJOUzogVGVzdCBwYXR0ZXJuc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZMQUdTOiBObyBpc3N1ZXMgZm91bmRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBSRUNPTU1FTkRBVElPTlM6IFNhdmUgbW9yZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfV1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIG1vY2tBeGlvcy5wb3N0Lm1vY2tSZXNvbHZlZFZhbHVlT25jZShtb2NrTExNUmVzcG9uc2UpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbGxtU2VydmljZS5hbmFseXplU3RhdGVtZW50KG1vY2tTdGF0ZW1lbnREYXRhKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcclxuICAgICAgICAgICAgZXhwZWN0KHJlc3VsdC5kYXRhKS50b0hhdmVQcm9wZXJ0eSgnc3VtbWFyeScpO1xyXG4gICAgICAgICAgICBleHBlY3QocmVzdWx0LmRhdGEpLnRvSGF2ZVByb3BlcnR5KCdwYXR0ZXJucycpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBBUEkgZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIG1vY2tBeGlvcy5wb3N0Lm1vY2tSZWplY3RlZFZhbHVlT25jZSh7XHJcbiAgICAgICAgICAgICAgICByZXNwb25zZToge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogNDI5LFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHsgZXJyb3I6ICdSYXRlIGxpbWl0IGV4Y2VlZGVkJyB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KGxsbVNlcnZpY2UuYW5hbHl6ZVN0YXRlbWVudChtb2NrU3RhdGVtZW50RGF0YSkpXHJcbiAgICAgICAgICAgICAgICAucmVqZWN0c1xyXG4gICAgICAgICAgICAgICAgLnRvVGhyb3coTExNRXJyb3IpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIEFQSSBrZXknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5QRVJQTEVYSVRZX0FQSV9LRVk7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlcnZpY2UgPSByZXF1aXJlKCcuLi8uLi9zcmMvc2VydmljZXMvbGxtU2VydmljZScpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuYW5hbHl6ZVN0YXRlbWVudChtb2NrU3RhdGVtZW50RGF0YSkpXHJcbiAgICAgICAgICAgICAgICAucmVqZWN0c1xyXG4gICAgICAgICAgICAgICAgLnRvVGhyb3coJ1BlcnBsZXhpdHkgQVBJIGtleSBub3QgY29uZmlndXJlZCcpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbn0pOyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDQyxPQUFPO0FBQ3BELE1BQU07RUFBRUM7QUFBUyxDQUFDLEdBQUdGLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQztBQUN0RCxNQUFNRyxVQUFVLEdBQUdILE9BQU8sQ0FBQywrQkFBK0IsQ0FBQzs7QUFFM0Q7QUFDQUksT0FBTyxDQUFDQyxHQUFHLENBQUNDLGtCQUFrQixHQUFHLGNBQWM7QUFDL0NGLE9BQU8sQ0FBQ0MsR0FBRyxDQUFDRSxrQkFBa0IsR0FBRyw0Q0FBNEM7QUFFN0VDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsTUFBTTtFQUMxQkMsVUFBVSxDQUFDLE1BQU07SUFDYkwsT0FBTyxDQUFDQyxHQUFHLENBQUNDLGtCQUFrQixHQUFHLGNBQWM7RUFDbkQsQ0FBQyxDQUFDO0VBRUZJLFNBQVMsQ0FBQyxNQUFNO0lBQ1pYLFNBQVMsQ0FBQ1ksS0FBSyxDQUFDLENBQUM7SUFDakJDLElBQUksQ0FBQ0MsYUFBYSxDQUFDLENBQUM7RUFD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