a9094cc259d4b642d64f20852eb5a372
"use strict";

_getJestObj().mock('../../src/config/redis');
_getJestObj().mock('../../src/utils/logger');
function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");
  _getJestObj = () => jest;
  return jest;
}
const RedisRateLimiter = require('../../src/middleware/rateLimiter');
const redis = require('../../src/config/redis');
describe('Redis Rate Limiter', () => {
  let rateLimiter;
  let mockReq;
  let mockRes;
  let mockNext;
  beforeEach(() => {
    rateLimiter = new RedisRateLimiter({
      windowMs: 1000,
      max: 2
    });
    mockReq = {
      ip: '127.0.0.1'
    };
    mockRes = {
      set: jest.fn(),
      status: jest.fn().mockReturnThis(),
      json: jest.fn()
    };
    mockNext = jest.fn();
    redis.incr.mockReset();
    redis.expire.mockReset();
    redis.ttl.mockReset();
  });
  it('should allow requests within limit', async () => {
    redis.incr.mockResolvedValue(1);
    redis.ttl.mockResolvedValue(60);
    await rateLimiter.middleware()(mockReq, mockRes, mockNext);
    expect(mockNext).toHaveBeenCalled();
    expect(mockRes.set).toHaveBeenCalledWith(expect.objectContaining({
      'X-RateLimit-Remaining': 1
    }));
  });
  it('should block requests over limit', async () => {
    redis.incr.mockResolvedValue(3);
    redis.ttl.mockResolvedValue(60);
    await rateLimiter.middleware()(mockReq, mockRes, mockNext);
    expect(mockRes.status).toHaveBeenCalledWith(429);
    expect(mockNext).not.toHaveBeenCalled();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJqZXN0IiwicmVxdWlyZSIsIlJlZGlzUmF0ZUxpbWl0ZXIiLCJyZWRpcyIsImRlc2NyaWJlIiwicmF0ZUxpbWl0ZXIiLCJtb2NrUmVxIiwibW9ja1JlcyIsIm1vY2tOZXh0IiwiYmVmb3JlRWFjaCIsIndpbmRvd01zIiwibWF4IiwiaXAiLCJzZXQiLCJmbiIsInN0YXR1cyIsIm1vY2tSZXR1cm5UaGlzIiwianNvbiIsImluY3IiLCJtb2NrUmVzZXQiLCJleHBpcmUiLCJ0dGwiLCJpdCIsIm1vY2tSZXNvbHZlZFZhbHVlIiwibWlkZGxld2FyZSIsImV4cGVjdCIsInRvSGF2ZUJlZW5DYWxsZWQiLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsIm9iamVjdENvbnRhaW5pbmciLCJub3QiXSwic291cmNlcyI6WyJyYXRlTGltaXRlci50ZXN0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFJlZGlzUmF0ZUxpbWl0ZXIgPSByZXF1aXJlKCcuLi8uLi9zcmMvbWlkZGxld2FyZS9yYXRlTGltaXRlcicpO1xyXG5jb25zdCByZWRpcyA9IHJlcXVpcmUoJy4uLy4uL3NyYy9jb25maWcvcmVkaXMnKTtcclxuXHJcbmplc3QubW9jaygnLi4vLi4vc3JjL2NvbmZpZy9yZWRpcycpO1xyXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy91dGlscy9sb2dnZXInKTtcclxuXHJcbmRlc2NyaWJlKCdSZWRpcyBSYXRlIExpbWl0ZXInLCAoKSA9PiB7XHJcbiAgICBsZXQgcmF0ZUxpbWl0ZXI7XHJcbiAgICBsZXQgbW9ja1JlcTtcclxuICAgIGxldCBtb2NrUmVzO1xyXG4gICAgbGV0IG1vY2tOZXh0O1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIHJhdGVMaW1pdGVyID0gbmV3IFJlZGlzUmF0ZUxpbWl0ZXIoe1xyXG4gICAgICAgICAgICB3aW5kb3dNczogMTAwMCxcclxuICAgICAgICAgICAgbWF4OiAyXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIG1vY2tSZXEgPSB7XHJcbiAgICAgICAgICAgIGlwOiAnMTI3LjAuMC4xJ1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIG1vY2tSZXMgPSB7XHJcbiAgICAgICAgICAgIHNldDogamVzdC5mbigpLFxyXG4gICAgICAgICAgICBzdGF0dXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxyXG4gICAgICAgICAgICBqc29uOiBqZXN0LmZuKClcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBtb2NrTmV4dCA9IGplc3QuZm4oKTtcclxuXHJcbiAgICAgICAgcmVkaXMuaW5jci5tb2NrUmVzZXQoKTtcclxuICAgICAgICByZWRpcy5leHBpcmUubW9ja1Jlc2V0KCk7XHJcbiAgICAgICAgcmVkaXMudHRsLm1vY2tSZXNldCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyByZXF1ZXN0cyB3aXRoaW4gbGltaXQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgcmVkaXMuaW5jci5tb2NrUmVzb2x2ZWRWYWx1ZSgxKTtcclxuICAgICAgICByZWRpcy50dGwubW9ja1Jlc29sdmVkVmFsdWUoNjApO1xyXG5cclxuICAgICAgICBhd2FpdCByYXRlTGltaXRlci5taWRkbGV3YXJlKCkobW9ja1JlcSwgbW9ja1JlcywgbW9ja05leHQpO1xyXG5cclxuICAgICAgICBleHBlY3QobW9ja05leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgICBleHBlY3QobW9ja1Jlcy5zZXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxyXG4gICAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XHJcbiAgICAgICAgICAgICAgICAnWC1SYXRlTGltaXQtUmVtYWluaW5nJzogMVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGJsb2NrIHJlcXVlc3RzIG92ZXIgbGltaXQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgcmVkaXMuaW5jci5tb2NrUmVzb2x2ZWRWYWx1ZSgzKTtcclxuICAgICAgICByZWRpcy50dGwubW9ja1Jlc29sdmVkVmFsdWUoNjApO1xyXG5cclxuICAgICAgICBhd2FpdCByYXRlTGltaXRlci5taWRkbGV3YXJlKCkobW9ja1JlcSwgbW9ja1JlcywgbW9ja05leHQpO1xyXG5cclxuICAgICAgICBleHBlY3QobW9ja1Jlcy5zdGF0dXMpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKDQyOSk7XHJcbiAgICAgICAgZXhwZWN0KG1vY2tOZXh0KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgfSk7XHJcbn0pOyJdLCJtYXBwaW5ncyI6Ijs7QUFHQUEsV0FBQSxHQUFLQyxJQUFJLENBQUMsd0JBQXdCLENBQUM7QUFDbkNELFdBQUEsR0FBS0MsSUFBSSxDQUFDLHdCQUF3QixDQUFDO0FBQUMsU0FBQUQsWUFBQTtFQUFBO0lBQUFFO0VBQUEsSUFBQUMsT0FBQTtFQUFBSCxXQUFBLEdBQUFBLENBQUEsS0FBQUUsSUFBQTtFQUFBLE9BQUFBLElBQUE7QUFBQTtBQUpwQyxNQUFNRSxnQkFBZ0IsR0FBR0QsT0FBTyxDQUFDLGtDQUFrQyxDQUFDO0FBQ3BFLE1BQU1FLEtBQUssR0FBR0YsT0FBTyxDQUFDLHdCQUF3QixDQUFDO0FBSy9DRyxRQUFRLENBQUMsb0JBQW9CLEVBQUUsTUFBTTtFQUNqQyxJQUFJQyxXQUFXO0VBQ2YsSUFBSUMsT0FBTztFQUNYLElBQUlDLE9BQU87RUFDWCxJQUFJQyxRQUFRO0VBRVpDLFVBQVUsQ0FBQyxNQUFNO0lBQ2JKLFdBQVcsR0FBRyxJQUFJSCxnQkFBZ0IsQ0FBQztNQUMvQlEsUUFBUSxFQUFFLElBQUk7TUFDZEMsR0FBRyxFQUFFO0lBQ1QsQ0FBQyxDQUFDO0lBRUZMLE9BQU8sR0FBRztNQUNOTSxFQUFFLEVBQUU7SUFDUixDQUFDO0lBRURMLE9BQU8sR0FBRztNQUNOTSxHQUFHLEVBQUViLElBQUksQ0FBQ2MsRUFBRSxDQUFDLENBQUM7TUFDZEMsTUFBTSxFQUFFZixJQUFJLENBQUNjLEVBQUUsQ0FBQyxDQUFDLENBQUNFLGNBQWMsQ0FBQyxDQUFDO01BQ2xDQyxJQUFJLEVBQUVqQixJQUFJLENBQUNjLEVBQUUsQ0FBQztJQUNsQixDQUFDO0lBRUROLFFBQVEsR0FBR1IsSUFBSSxDQUFDYyxFQUFFLENBQUMsQ0FBQztJQUVwQlgsS0FBSyxDQUFDZSxJQUFJLENBQUNDLFNBQVMsQ0FBQyxDQUFDO0lBQ3RCaEIsS0FBSyxDQUFDaUIsTUFBTSxDQUFDRCxTQUFTLENBQUMsQ0FBQztJQUN4QmhCLEtBQUssQ0FBQ2tCLEdBQUcsQ0FBQ0YsU0FBUyxDQUFDLENBQUM7RUFDekIsQ0FBQyxDQUFDO0VBRUZHLEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxZQUFZO0lBQ2pEbkIsS0FBSyxDQUFDZSxJQUFJLENBQUNLLGlCQUFpQixDQUFDLENBQUMsQ0FBQztJQUMvQnBCLEtBQUssQ0FBQ2tCLEdBQUcsQ0FBQ0UsaUJBQWlCLENBQUMsRUFBRSxDQUFDO0lBRS9CLE1BQU1sQixXQUFXLENBQUNtQixVQUFVLENBQUMsQ0FBQyxDQUFDbEIsT0FBTyxFQUFFQyxPQUFPLEVBQUVDLFFBQVEsQ0FBQztJQUUxRGlCLE1BQU0sQ0FBQ2pCLFFBQVEsQ0FBQyxDQUFDa0IsZ0JBQWdCLENBQUMsQ0FBQztJQUNuQ0QsTUFBTSxDQUFDbEIsT0FBTyxDQUFDTSxHQUFHLENBQUMsQ0FBQ2Msb0JBQW9CLENBQ3BDRixNQUFNLENBQUNHLGdCQUFnQixDQUFDO01BQ3BCLHVCQUF1QixFQUFFO0lBQzdCLENBQUMsQ0FDTCxDQUFDO0VBQ0wsQ0FBQyxDQUFDO0VBRUZOLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxZQUFZO0lBQy9DbkIsS0FBSyxDQUFDZSxJQUFJLENBQUNLLGlCQUFpQixDQUFDLENBQUMsQ0FBQztJQUMvQnBCLEtBQUssQ0FBQ2tCLEdBQUcsQ0FBQ0UsaUJBQWlCLENBQUMsRUFBRSxDQUFDO0lBRS9CLE1BQU1sQixXQUFXLENBQUNtQixVQUFVLENBQUMsQ0FBQyxDQUFDbEIsT0FBTyxFQUFFQyxPQUFPLEVBQUVDLFFBQVEsQ0FBQztJQUUxRGlCLE1BQU0sQ0FBQ2xCLE9BQU8sQ0FBQ1EsTUFBTSxDQUFDLENBQUNZLG9CQUFvQixDQUFDLEdBQUcsQ0FBQztJQUNoREYsTUFBTSxDQUFDakIsUUFBUSxDQUFDLENBQUNxQixHQUFHLENBQUNILGdCQUFnQixDQUFDLENBQUM7RUFDM0MsQ0FBQyxDQUFDO0FBQ04sQ0FBQyxDQUFDIiwiaWdub3JlTGlzdCI6W119