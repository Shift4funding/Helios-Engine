{"version":3,"names":["_getJestObj","mock","jest","require","RedisRateLimiter","redis","describe","rateLimiter","mockReq","mockRes","mockNext","beforeEach","windowMs","max","ip","set","fn","status","mockReturnThis","json","incr","mockReset","expire","ttl","it","mockResolvedValue","middleware","expect","toHaveBeenCalled","toHaveBeenCalledWith","objectContaining","not"],"sources":["rateLimiter.test.js"],"sourcesContent":["const RedisRateLimiter = require('../../src/middleware/rateLimiter');\r\nconst redis = require('../../src/config/redis');\r\n\r\njest.mock('../../src/config/redis');\r\njest.mock('../../src/utils/logger');\r\n\r\ndescribe('Redis Rate Limiter', () => {\r\n    let rateLimiter;\r\n    let mockReq;\r\n    let mockRes;\r\n    let mockNext;\r\n\r\n    beforeEach(() => {\r\n        rateLimiter = new RedisRateLimiter({\r\n            windowMs: 1000,\r\n            max: 2\r\n        });\r\n\r\n        mockReq = {\r\n            ip: '127.0.0.1'\r\n        };\r\n\r\n        mockRes = {\r\n            set: jest.fn(),\r\n            status: jest.fn().mockReturnThis(),\r\n            json: jest.fn()\r\n        };\r\n\r\n        mockNext = jest.fn();\r\n\r\n        redis.incr.mockReset();\r\n        redis.expire.mockReset();\r\n        redis.ttl.mockReset();\r\n    });\r\n\r\n    it('should allow requests within limit', async () => {\r\n        redis.incr.mockResolvedValue(1);\r\n        redis.ttl.mockResolvedValue(60);\r\n\r\n        await rateLimiter.middleware()(mockReq, mockRes, mockNext);\r\n\r\n        expect(mockNext).toHaveBeenCalled();\r\n        expect(mockRes.set).toHaveBeenCalledWith(\r\n            expect.objectContaining({\r\n                'X-RateLimit-Remaining': 1\r\n            })\r\n        );\r\n    });\r\n\r\n    it('should block requests over limit', async () => {\r\n        redis.incr.mockResolvedValue(3);\r\n        redis.ttl.mockResolvedValue(60);\r\n\r\n        await rateLimiter.middleware()(mockReq, mockRes, mockNext);\r\n\r\n        expect(mockRes.status).toHaveBeenCalledWith(429);\r\n        expect(mockNext).not.toHaveBeenCalled();\r\n    });\r\n});"],"mappings":";;AAGAA,WAAA,GAAKC,IAAI,CAAC,wBAAwB,CAAC;AACnCD,WAAA,GAAKC,IAAI,CAAC,wBAAwB,CAAC;AAAC,SAAAD,YAAA;EAAA;IAAAE;EAAA,IAAAC,OAAA;EAAAH,WAAA,GAAAA,CAAA,KAAAE,IAAA;EAAA,OAAAA,IAAA;AAAA;AAJpC,MAAME,gBAAgB,GAAGD,OAAO,CAAC,kCAAkC,CAAC;AACpE,MAAME,KAAK,GAAGF,OAAO,CAAC,wBAAwB,CAAC;AAK/CG,QAAQ,CAAC,oBAAoB,EAAE,MAAM;EACjC,IAAIC,WAAW;EACf,IAAIC,OAAO;EACX,IAAIC,OAAO;EACX,IAAIC,QAAQ;EAEZC,UAAU,CAAC,MAAM;IACbJ,WAAW,GAAG,IAAIH,gBAAgB,CAAC;MAC/BQ,QAAQ,EAAE,IAAI;MACdC,GAAG,EAAE;IACT,CAAC,CAAC;IAEFL,OAAO,GAAG;MACNM,EAAE,EAAE;IACR,CAAC;IAEDL,OAAO,GAAG;MACNM,GAAG,EAAEb,IAAI,CAACc,EAAE,CAAC,CAAC;MACdC,MAAM,EAAEf,IAAI,CAACc,EAAE,CAAC,CAAC,CAACE,cAAc,CAAC,CAAC;MAClCC,IAAI,EAAEjB,IAAI,CAACc,EAAE,CAAC;IAClB,CAAC;IAEDN,QAAQ,GAAGR,IAAI,CAACc,EAAE,CAAC,CAAC;IAEpBX,KAAK,CAACe,IAAI,CAACC,SAAS,CAAC,CAAC;IACtBhB,KAAK,CAACiB,MAAM,CAACD,SAAS,CAAC,CAAC;IACxBhB,KAAK,CAACkB,GAAG,CAACF,SAAS,CAAC,CAAC;EACzB,CAAC,CAAC;EAEFG,EAAE,CAAC,oCAAoC,EAAE,YAAY;IACjDnB,KAAK,CAACe,IAAI,CAACK,iBAAiB,CAAC,CAAC,CAAC;IAC/BpB,KAAK,CAACkB,GAAG,CAACE,iBAAiB,CAAC,EAAE,CAAC;IAE/B,MAAMlB,WAAW,CAACmB,UAAU,CAAC,CAAC,CAAClB,OAAO,EAAEC,OAAO,EAAEC,QAAQ,CAAC;IAE1DiB,MAAM,CAACjB,QAAQ,CAAC,CAACkB,gBAAgB,CAAC,CAAC;IACnCD,MAAM,CAAClB,OAAO,CAACM,GAAG,CAAC,CAACc,oBAAoB,CACpCF,MAAM,CAACG,gBAAgB,CAAC;MACpB,uBAAuB,EAAE;IAC7B,CAAC,CACL,CAAC;EACL,CAAC,CAAC;EAEFN,EAAE,CAAC,kCAAkC,EAAE,YAAY;IAC/CnB,KAAK,CAACe,IAAI,CAACK,iBAAiB,CAAC,CAAC,CAAC;IAC/BpB,KAAK,CAACkB,GAAG,CAACE,iBAAiB,CAAC,EAAE,CAAC;IAE/B,MAAMlB,WAAW,CAACmB,UAAU,CAAC,CAAC,CAAClB,OAAO,EAAEC,OAAO,EAAEC,QAAQ,CAAC;IAE1DiB,MAAM,CAAClB,OAAO,CAACQ,MAAM,CAAC,CAACY,oBAAoB,CAAC,GAAG,CAAC;IAChDF,MAAM,CAACjB,QAAQ,CAAC,CAACqB,GAAG,CAACH,gBAAgB,CAAC,CAAC;EAC3C,CAAC,CAAC;AACN,CAAC,CAAC","ignoreList":[]}