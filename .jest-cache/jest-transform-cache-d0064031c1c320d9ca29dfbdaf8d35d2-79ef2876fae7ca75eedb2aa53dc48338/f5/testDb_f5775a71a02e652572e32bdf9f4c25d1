8acfb2052e6d47e5e896ccb13fbac381
"use strict";

const mongoose = require('mongoose');
const {
  MongoMemoryServer
} = require('mongodb-memory-server');
const winston = require('winston');
const logger = winston.createLogger({
  level: 'error',
  transports: [new winston.transports.Console({
    format: winston.format.simple()
  })]
});
let mongoServer;
const setupTestDatabase = async () => {
  try {
    // Close existing connections
    await mongoose.disconnect();

    // Create new server instance
    mongoServer = await MongoMemoryServer.create();
    const mongoUri = mongoServer.getUri();

    // Connect to the in-memory database
    await mongoose.connect(mongoUri);
    logger.info('Test database connected');
  } catch (error) {
    logger.error('Test database setup failed:', error);
    throw error;
  }
};
const cleanupTestDatabase = async () => {
  try {
    // Only cleanup if we have an active connection
    if (mongoose.connection.readyState !== 0) {
      await mongoose.connection.dropDatabase();
      await mongoose.disconnect();
    }

    // Stop the in-memory server
    if (mongoServer) {
      await mongoServer.stop();
      mongoServer = null;
    }
    logger.info('Test database cleanup completed');
  } catch (error) {
    logger.error('Test database cleanup failed:', error);
    throw error;
  }
};
module.exports = {
  setupTestDatabase,
  cleanupTestDatabase
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJtb25nb29zZSIsInJlcXVpcmUiLCJNb25nb01lbW9yeVNlcnZlciIsIndpbnN0b24iLCJsb2dnZXIiLCJjcmVhdGVMb2dnZXIiLCJsZXZlbCIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwiZm9ybWF0Iiwic2ltcGxlIiwibW9uZ29TZXJ2ZXIiLCJzZXR1cFRlc3REYXRhYmFzZSIsImRpc2Nvbm5lY3QiLCJjcmVhdGUiLCJtb25nb1VyaSIsImdldFVyaSIsImNvbm5lY3QiLCJpbmZvIiwiZXJyb3IiLCJjbGVhbnVwVGVzdERhdGFiYXNlIiwiY29ubmVjdGlvbiIsInJlYWR5U3RhdGUiLCJkcm9wRGF0YWJhc2UiLCJzdG9wIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInRlc3REYi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBtb25nb29zZSA9IHJlcXVpcmUoJ21vbmdvb3NlJyk7XHJcbmNvbnN0IHsgTW9uZ29NZW1vcnlTZXJ2ZXIgfSA9IHJlcXVpcmUoJ21vbmdvZGItbWVtb3J5LXNlcnZlcicpO1xyXG5jb25zdCB3aW5zdG9uID0gcmVxdWlyZSgnd2luc3RvbicpO1xyXG5cclxuY29uc3QgbG9nZ2VyID0gd2luc3Rvbi5jcmVhdGVMb2dnZXIoe1xyXG4gICAgbGV2ZWw6ICdlcnJvcicsXHJcbiAgICB0cmFuc3BvcnRzOiBbXHJcbiAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKHtcclxuICAgICAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5zaW1wbGUoKVxyXG4gICAgICAgIH0pXHJcbiAgICBdXHJcbn0pO1xyXG5cclxubGV0IG1vbmdvU2VydmVyO1xyXG5cclxuY29uc3Qgc2V0dXBUZXN0RGF0YWJhc2UgPSBhc3luYyAoKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vIENsb3NlIGV4aXN0aW5nIGNvbm5lY3Rpb25zXHJcbiAgICAgICAgYXdhaXQgbW9uZ29vc2UuZGlzY29ubmVjdCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENyZWF0ZSBuZXcgc2VydmVyIGluc3RhbmNlXHJcbiAgICAgICAgbW9uZ29TZXJ2ZXIgPSBhd2FpdCBNb25nb01lbW9yeVNlcnZlci5jcmVhdGUoKTtcclxuICAgICAgICBjb25zdCBtb25nb1VyaSA9IG1vbmdvU2VydmVyLmdldFVyaSgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIENvbm5lY3QgdG8gdGhlIGluLW1lbW9yeSBkYXRhYmFzZVxyXG4gICAgICAgIGF3YWl0IG1vbmdvb3NlLmNvbm5lY3QobW9uZ29VcmkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IGRhdGFiYXNlIGNvbm5lY3RlZCcpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBsb2dnZXIuZXJyb3IoJ1Rlc3QgZGF0YWJhc2Ugc2V0dXAgZmFpbGVkOicsIGVycm9yKTtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxufTtcclxuXHJcbmNvbnN0IGNsZWFudXBUZXN0RGF0YWJhc2UgPSBhc3luYyAoKSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vIE9ubHkgY2xlYW51cCBpZiB3ZSBoYXZlIGFuIGFjdGl2ZSBjb25uZWN0aW9uXHJcbiAgICAgICAgaWYgKG1vbmdvb3NlLmNvbm5lY3Rpb24ucmVhZHlTdGF0ZSAhPT0gMCkge1xyXG4gICAgICAgICAgICBhd2FpdCBtb25nb29zZS5jb25uZWN0aW9uLmRyb3BEYXRhYmFzZSgpO1xyXG4gICAgICAgICAgICBhd2FpdCBtb25nb29zZS5kaXNjb25uZWN0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIFN0b3AgdGhlIGluLW1lbW9yeSBzZXJ2ZXJcclxuICAgICAgICBpZiAobW9uZ29TZXJ2ZXIpIHtcclxuICAgICAgICAgICAgYXdhaXQgbW9uZ29TZXJ2ZXIuc3RvcCgpO1xyXG4gICAgICAgICAgICBtb25nb1NlcnZlciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxvZ2dlci5pbmZvKCdUZXN0IGRhdGFiYXNlIGNsZWFudXAgY29tcGxldGVkJyk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcignVGVzdCBkYXRhYmFzZSBjbGVhbnVwIGZhaWxlZDonLCBlcnJvcik7XHJcbiAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAgIHNldHVwVGVzdERhdGFiYXNlLFxyXG4gICAgY2xlYW51cFRlc3REYXRhYmFzZVxyXG59OyJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFVLENBQUM7QUFDcEMsTUFBTTtFQUFFQztBQUFrQixDQUFDLEdBQUdELE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUM5RCxNQUFNRSxPQUFPLEdBQUdGLE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFFbEMsTUFBTUcsTUFBTSxHQUFHRCxPQUFPLENBQUNFLFlBQVksQ0FBQztFQUNoQ0MsS0FBSyxFQUFFLE9BQU87RUFDZEMsVUFBVSxFQUFFLENBQ1IsSUFBSUosT0FBTyxDQUFDSSxVQUFVLENBQUNDLE9BQU8sQ0FBQztJQUMzQkMsTUFBTSxFQUFFTixPQUFPLENBQUNNLE1BQU0sQ0FBQ0MsTUFBTSxDQUFDO0VBQ2xDLENBQUMsQ0FBQztBQUVWLENBQUMsQ0FBQztBQUVGLElBQUlDLFdBQVc7QUFFZixNQUFNQyxpQkFBaUIsR0FBRyxNQUFBQSxDQUFBLEtBQVk7RUFDbEMsSUFBSTtJQUNBO0lBQ0EsTUFBTVosUUFBUSxDQUFDYSxVQUFVLENBQUMsQ0FBQzs7SUFFM0I7SUFDQUYsV0FBVyxHQUFHLE1BQU1ULGlCQUFpQixDQUFDWSxNQUFNLENBQUMsQ0FBQztJQUM5QyxNQUFNQyxRQUFRLEdBQUdKLFdBQVcsQ0FBQ0ssTUFBTSxDQUFDLENBQUM7O0lBRXJDO0lBQ0EsTUFBTWhCLFFBQVEsQ0FBQ2lCLE9BQU8sQ0FBQ0YsUUFBUSxDQUFDO0lBRWhDWCxNQUFNLENBQUNjLElBQUksQ0FBQyx5QkFBeUIsQ0FBQztFQUMxQyxDQUFDLENBQUMsT0FBT0MsS0FBSyxFQUFFO0lBQ1pmLE1BQU0sQ0FBQ2UsS0FBSyxDQUFDLDZCQUE2QixFQUFFQSxLQUFLLENBQUM7SUFDbEQsTUFBTUEsS0FBSztFQUNmO0FBQ0osQ0FBQztBQUVELE1BQU1DLG1CQUFtQixHQUFHLE1BQUFBLENBQUEsS0FBWTtFQUNwQyxJQUFJO0lBQ0E7SUFDQSxJQUFJcEIsUUFBUSxDQUFDcUIsVUFBVSxDQUFDQyxVQUFVLEtBQUssQ0FBQyxFQUFFO01BQ3RDLE1BQU10QixRQUFRLENBQUNxQixVQUFVLENBQUNFLFlBQVksQ0FBQyxDQUFDO01BQ3hDLE1BQU12QixRQUFRLENBQUNhLFVBQVUsQ0FBQyxDQUFDO0lBQy9COztJQUVBO0lBQ0EsSUFBSUYsV0FBVyxFQUFFO01BQ2IsTUFBTUEsV0FBVyxDQUFDYSxJQUFJLENBQUMsQ0FBQztNQUN4QmIsV0FBVyxHQUFHLElBQUk7SUFDdEI7SUFFQVAsTUFBTSxDQUFDYyxJQUFJLENBQUMsaUNBQWlDLENBQUM7RUFDbEQsQ0FBQyxDQUFDLE9BQU9DLEtBQUssRUFBRTtJQUNaZixNQUFNLENBQUNlLEtBQUssQ0FBQywrQkFBK0IsRUFBRUEsS0FBSyxDQUFDO0lBQ3BELE1BQU1BLEtBQUs7RUFDZjtBQUNKLENBQUM7QUFFRE0sTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDYmQsaUJBQWlCO0VBQ2pCUTtBQUNKLENBQUMiLCJpZ25vcmVMaXN0IjpbXX0=