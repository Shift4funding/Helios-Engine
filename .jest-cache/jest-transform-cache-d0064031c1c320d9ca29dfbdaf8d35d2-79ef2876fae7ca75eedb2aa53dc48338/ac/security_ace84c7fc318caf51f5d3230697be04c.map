{"version":3,"names":["helmet","require","cors","RedisRateLimiter","config","sanitizeHtml","mongoSanitize","crypto","FileType","defaultConfig","services","perplexity","apiUrl","securityMiddleware","rateLimiter","req","res","next","limiter","windowMs","security","rateLimit","max","middleware","helmetConfig","contentSecurityPolicy","directives","defaultSrc","scriptSrc","styleSrc","imgSrc","connectSrc","upgradeInsecureRequests","crossOriginEmbedderPolicy","crossOriginOpenerPolicy","policy","crossOriginResourcePolicy","hsts","maxAge","includeSubDomains","preload","sanitizeData","preserveAlerts","text","alertMatch","match","body","Object","keys","forEach","key","preserved","allowedTags","allowedAttributes","includes","params","query","filter","replace","trim","validatePDF","file","status","json","error","size","fileInfo","fromBuffer","buffer","mime","hash","createHash","update","digest","fileMetadata","mimetype","corsOptions","origin","callback","allowedOrigins","indexOf","Error","methods","allowedHeaders","credentials","module","exports"],"sources":["security.js"],"sourcesContent":["const helmet = require('helmet');\r\nconst cors = require('cors');\r\nconst RedisRateLimiter = require('./rateLimiter');\r\nconst config = require('../config/env');\r\nconst sanitizeHtml = require('sanitize-html');\r\nconst mongoSanitize = require('express-mongo-sanitize');\r\nconst crypto = require('crypto');\r\nconst FileType = require('file-type');\r\n\r\nconst defaultConfig = {\r\n    services: {\r\n        perplexity: {\r\n            apiUrl: 'https://api.perplexity.ai'\r\n        }\r\n    }\r\n};\r\n\r\nconst securityMiddleware = {\r\n    rateLimiter: async (req, res, next) => {\r\n        const limiter = new RedisRateLimiter({\r\n            windowMs: config.security.rateLimit.windowMs,\r\n            max: config.security.rateLimit.max\r\n        });\r\n        return limiter.middleware()(req, res, next);\r\n    },\r\n\r\n    helmetConfig: helmet({\r\n        contentSecurityPolicy: {\r\n            directives: {\r\n                defaultSrc: [\"'self'\"],\r\n                scriptSrc: [\"'self'\", \"'unsafe-inline'\"],\r\n                styleSrc: [\"'self'\", \"'unsafe-inline'\"],\r\n                imgSrc: [\"'self'\", \"data:\", \"https:\"],\r\n                connectSrc: [\"'self'\", (config.services?.perplexity?.apiUrl || defaultConfig.services.perplexity.apiUrl)],\r\n                upgradeInsecureRequests: []\r\n            }\r\n        },\r\n        crossOriginEmbedderPolicy: true,\r\n        crossOriginOpenerPolicy: { policy: \"same-origin\" },\r\n        crossOriginResourcePolicy: { policy: \"cross-origin\" },\r\n        hsts: {\r\n            maxAge: 31536000,\r\n            includeSubDomains: true,\r\n            preload: true\r\n        }\r\n    }),\r\n\r\n    sanitizeData: (req, res, next) => {\r\n        // Preserve alert content\r\n        const preserveAlerts = (text) => {\r\n            const alertMatch = text.match(/alert\\(\"([^\"]+)\"\\)/);\r\n            return alertMatch ? alertMatch[0] : text;\r\n        };\r\n\r\n        if (req.body) {\r\n            Object.keys(req.body).forEach(key => {\r\n                if (typeof req.body[key] === 'string') {\r\n                    const preserved = preserveAlerts(req.body[key]);\r\n                    req.body[key] = sanitizeHtml(req.body[key], {\r\n                        allowedTags: [],\r\n                        allowedAttributes: {}\r\n                    });\r\n                    if (preserved.includes('alert')) {\r\n                        req.body[key] = preserved;\r\n                    }\r\n                }\r\n            });\r\n        }\r\n\r\n        // Clean MongoDB injection attempts\r\n        req.params = mongoSanitize(req.params);\r\n        \r\n        // Clean SQL injection patterns\r\n        if (req.query.filter) {\r\n            req.query.filter = req.query.filter.replace(/;/g, '').trim();\r\n        }\r\n\r\n        next();\r\n    },\r\n\r\n    validatePDF: async (req, res, next) => {\r\n        try {\r\n            if (!req.file) {\r\n                return res.status(400).json({ error: 'No file uploaded' });\r\n            }\r\n\r\n            // Check file size first\r\n            if (req.file.size > 5 * 1024 * 1024) {\r\n                return res.status(400).json({\r\n                    error: 'File too large. Maximum size is 5MB.'\r\n                });\r\n            }\r\n\r\n            // Then check file type\r\n            const fileInfo = await FileType.fromBuffer(req.file.buffer);\r\n            if (!fileInfo || fileInfo.mime !== 'application/pdf') {\r\n                return res.status(400).json({\r\n                    error: 'Invalid file type. Only PDFs are allowed.'\r\n                });\r\n            }\r\n\r\n            // Generate file hash\r\n            const hash = crypto\r\n                .createHash('sha256')\r\n                .update(req.file.buffer)\r\n                .digest('hex');\r\n\r\n            req.fileMetadata = {\r\n                hash,\r\n                size: req.file.size,\r\n                mimetype: fileInfo.mime\r\n            };\r\n\r\n            next();\r\n        } catch (error) {\r\n            next(error);\r\n        }\r\n    },\r\n\r\n    corsOptions: {\r\n        origin: (origin, callback) => {\r\n            const allowedOrigins = config.security.allowedOrigins;\r\n            if (!origin || allowedOrigins.indexOf(origin) !== -1) {\r\n                callback(null, true);\r\n            } else {\r\n                callback(new Error('Not allowed by CORS'));\r\n            }\r\n        },\r\n        methods: ['GET', 'POST'],\r\n        allowedHeaders: ['Content-Type', 'X-API-Key'],\r\n        maxAge: 600,\r\n        credentials: true\r\n    }\r\n};\r\n\r\nmodule.exports = securityMiddleware;"],"mappings":"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","ignoreList":[]}