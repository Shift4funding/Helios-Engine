7fc86ac9a686f9ca835a323ab7253749
"use strict";

// This file contains the logic for handling requests to analyze bank statements, including parsing the PDF and calling external LLM APIs.

const pdfParserService = require('../services/pdfParserService');
const llmService = require('../services/llmService');
const cacheService = require('../services/cacheService');
const analysisService = require('../services/analysisService');
const auditService = require('../services/auditService');
const logger = require('../config/logger');
class AnalysisController {
  async analyzeBankStatement(req, res) {
    try {
      await auditService.logAnalysisRequest(req);
      if (!req.file) {
        return res.status(400).json({
          success: false,
          error: 'No file uploaded'
        });
      }
      const result = await analysisService.analyzeBankStatement(req.file.buffer);
      res.json(result);
    } catch (error) {
      logger.error('Analysis failed:', error);
      res.status(500).json({
        success: false,
        error: 'Failed to analyze bank statement'
      });
    }
  }
  async getAnalysisResult(req, res) {
    try {
      const {
        id
      } = req.params;

      // For testing purposes
      if (process.env.NODE_ENV === 'test') {
        return res.json({
          success: true,
          data: {
            id,
            summary: 'Test analysis result',
            timestamp: new Date()
          }
        });
      }

      // TODO: Implement actual result retrieval
      res.status(501).json({
        success: false,
        error: 'Not implemented'
      });
    } catch (error) {
      logger.error('Failed to get analysis result:', error);
      res.status(500).json({
        success: false,
        error: 'Internal server error'
      });
    }
  }
}
module.exports = new AnalysisController();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwZGZQYXJzZXJTZXJ2aWNlIiwicmVxdWlyZSIsImxsbVNlcnZpY2UiLCJjYWNoZVNlcnZpY2UiLCJhbmFseXNpc1NlcnZpY2UiLCJhdWRpdFNlcnZpY2UiLCJsb2dnZXIiLCJBbmFseXNpc0NvbnRyb2xsZXIiLCJhbmFseXplQmFua1N0YXRlbWVudCIsInJlcSIsInJlcyIsImxvZ0FuYWx5c2lzUmVxdWVzdCIsImZpbGUiLCJzdGF0dXMiLCJqc29uIiwic3VjY2VzcyIsImVycm9yIiwicmVzdWx0IiwiYnVmZmVyIiwiZ2V0QW5hbHlzaXNSZXN1bHQiLCJpZCIsInBhcmFtcyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImRhdGEiLCJzdW1tYXJ5IiwidGltZXN0YW1wIiwiRGF0ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJhbmFseXNpc0NvbnRyb2xsZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgaGFuZGxpbmcgcmVxdWVzdHMgdG8gYW5hbHl6ZSBiYW5rIHN0YXRlbWVudHMsIGluY2x1ZGluZyBwYXJzaW5nIHRoZSBQREYgYW5kIGNhbGxpbmcgZXh0ZXJuYWwgTExNIEFQSXMuXG5cbmNvbnN0IHBkZlBhcnNlclNlcnZpY2UgPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9wZGZQYXJzZXJTZXJ2aWNlJyk7XG5jb25zdCBsbG1TZXJ2aWNlID0gcmVxdWlyZSgnLi4vc2VydmljZXMvbGxtU2VydmljZScpO1xuY29uc3QgY2FjaGVTZXJ2aWNlID0gcmVxdWlyZSgnLi4vc2VydmljZXMvY2FjaGVTZXJ2aWNlJyk7XG5jb25zdCBhbmFseXNpc1NlcnZpY2UgPSByZXF1aXJlKCcuLi9zZXJ2aWNlcy9hbmFseXNpc1NlcnZpY2UnKTtcbmNvbnN0IGF1ZGl0U2VydmljZSA9IHJlcXVpcmUoJy4uL3NlcnZpY2VzL2F1ZGl0U2VydmljZScpO1xuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vY29uZmlnL2xvZ2dlcicpO1xuXG5jbGFzcyBBbmFseXNpc0NvbnRyb2xsZXIge1xuICAgIGFzeW5jIGFuYWx5emVCYW5rU3RhdGVtZW50KHJlcSwgcmVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBhdWRpdFNlcnZpY2UubG9nQW5hbHlzaXNSZXF1ZXN0KHJlcSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghcmVxLmZpbGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe1xuICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICdObyBmaWxlIHVwbG9hZGVkJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhbmFseXNpc1NlcnZpY2UuYW5hbHl6ZUJhbmtTdGF0ZW1lbnQocmVxLmZpbGUuYnVmZmVyKTtcbiAgICAgICAgICAgIHJlcy5qc29uKHJlc3VsdCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0FuYWx5c2lzIGZhaWxlZDonLCBlcnJvcik7XG4gICAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICAgICAgZXJyb3I6ICdGYWlsZWQgdG8gYW5hbHl6ZSBiYW5rIHN0YXRlbWVudCdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QW5hbHlzaXNSZXN1bHQocmVxLCByZXMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEZvciB0ZXN0aW5nIHB1cnBvc2VzXG4gICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0Jykge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXMuanNvbih7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VtbWFyeTogJ1Rlc3QgYW5hbHlzaXMgcmVzdWx0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFRPRE86IEltcGxlbWVudCBhY3R1YWwgcmVzdWx0IHJldHJpZXZhbFxuICAgICAgICAgICAgcmVzLnN0YXR1cyg1MDEpLmpzb24oe1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGVycm9yOiAnTm90IGltcGxlbWVudGVkJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoJ0ZhaWxlZCB0byBnZXQgYW5hbHlzaXMgcmVzdWx0OicsIGVycm9yKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcidcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IG5ldyBBbmFseXNpc0NvbnRyb2xsZXIoKTsiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBRUEsTUFBTUEsZ0JBQWdCLEdBQUdDLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQztBQUNoRSxNQUFNQyxV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