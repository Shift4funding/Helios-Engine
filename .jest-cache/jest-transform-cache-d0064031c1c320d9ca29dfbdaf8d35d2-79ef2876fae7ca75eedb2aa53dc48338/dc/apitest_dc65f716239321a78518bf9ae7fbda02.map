{"version":3,"names":["_getJestObj","mock","analyzeStatement","jest","fn","mockImplementation","data","success","summary","accountInfo","accountHolder","patterns","flags","transactions","length","recommendations","require","request","path","app","LLMError","describe","FIXTURES_PATH","join","__dirname","API_KEY","beforeEach","process","env","clearAllMocks","it","response","post","set","attach","expect","status","toBe","body","toHaveProperty","__filename","message","toContain","largeBuffer","Buffer","alloc","invalidPdfBuffer","from","toMatch","makeRequest","responses","Promise","all","forEach","send","someData","llmService","mockRejectedValueOnce","mockImplementationOnce","_","reject","setTimeout","Error","get"],"sources":["api.test.js"],"sourcesContent":["const request = require('supertest');\r\nconst path = require('path');\r\nconst app = require('../../src/app');\r\nconst { LLMError } = require('../../src/utils/errors');\r\n\r\n// Mock LLM service with more realistic responses\r\njest.mock('../../src/services/llmService', () => ({\r\n    analyzeStatement: jest.fn().mockImplementation(async (data) => ({\r\n        success: true,\r\n        data: {\r\n            summary: `Analysis for account ${data.accountInfo.accountHolder}'s statement`,\r\n            patterns: 'Regular monthly deposits and withdrawals detected',\r\n            flags: data.transactions.length > 5 ? 'High transaction volume' : 'No issues found',\r\n            recommendations: 'Consider setting up automatic savings'\r\n        }\r\n    }))\r\n}));\r\n\r\ndescribe('API Integration', () => {\r\n    const FIXTURES_PATH = path.join(__dirname, '../fixtures');\r\n    const API_KEY = 'test-api-key';\r\n\r\n    beforeEach(() => {\r\n        process.env.API_KEY = API_KEY;\r\n        jest.clearAllMocks();\r\n    });\r\n\r\n    describe('POST /api/analysis/statement', () => {\r\n        it('should analyze PDF statement successfully', async () => {\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', path.join(FIXTURES_PATH, 'sample-statement.pdf'));\r\n\r\n            expect(response.status).toBe(200);\r\n            expect(response.body).toHaveProperty('success', true);\r\n            expect(response.body.data).toHaveProperty('parsedStatement');\r\n            expect(response.body.data).toHaveProperty('analysis');\r\n        });\r\n\r\n        it('should reject non-PDF files', async () => {\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', __filename); // Attaching this test file\r\n\r\n            expect(response.status).toBe(400);\r\n            expect(response.body).toHaveProperty('status', 'error');\r\n            expect(response.body.message).toContain('Only PDF files are allowed');\r\n        });\r\n\r\n        it('should enforce file size limit', async () => {\r\n            // Create a large buffer\r\n            const largeBuffer = Buffer.alloc(11 * 1024 * 1024); // 11MB\r\n\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', largeBuffer, 'large.pdf');\r\n\r\n            expect(response.status).toBe(400);\r\n            expect(response.body.message).toContain('File size too large');\r\n        });\r\n\r\n        it('should handle missing file', async () => {\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY);\r\n\r\n            expect(response.status).toBe(400);\r\n            expect(response.body.message).toContain('No PDF file provided');\r\n        });\r\n\r\n        it('should require API key', async () => {\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .attach('bankStatement', path.join(FIXTURES_PATH, 'sample-statement.pdf'));\r\n\r\n            expect(response.status).toBe(401);\r\n            expect(response.body.message).toContain('Invalid or missing API key');\r\n        });\r\n\r\n        it('should handle malformed PDF files', async () => {\r\n            // Create a fake PDF with invalid content\r\n            const invalidPdfBuffer = Buffer.from('%PDF-1.7\\nInvalid PDF Content');\r\n            \r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', invalidPdfBuffer, 'invalid.pdf');\r\n\r\n            expect(response.status).toBe(400);\r\n            expect(response.body).toHaveProperty('status', 'error');\r\n            expect(response.body.message).toMatch(/Failed to parse PDF/i);\r\n        });\r\n\r\n        it('should handle concurrent requests', async () => {\r\n            const makeRequest = () => request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', path.join(FIXTURES_PATH, 'sample-statement.pdf'));\r\n\r\n            const responses = await Promise.all([\r\n                makeRequest(),\r\n                makeRequest(),\r\n                makeRequest()\r\n            ]);\r\n\r\n            responses.forEach(response => {\r\n                expect(response.status).toBe(200);\r\n                expect(response.body).toHaveProperty('success', true);\r\n            });\r\n        });\r\n\r\n        it('should validate request content-type', async () => {\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .set('Content-Type', 'application/json')\r\n                .send({ someData: 'not a PDF' });\r\n\r\n            expect(response.status).toBe(400);\r\n            expect(response.body.message).toContain('Invalid request format');\r\n        });\r\n    });\r\n\r\n    describe('Error Handling', () => {\r\n        it('should handle LLM service errors gracefully', async () => {\r\n            const llmService = require('../../src/services/llmService');\r\n            llmService.analyzeStatement.mockRejectedValueOnce(\r\n                new LLMError('Service unavailable', 503)\r\n            );\r\n\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', path.join(FIXTURES_PATH, 'sample-statement.pdf'));\r\n\r\n            expect(response.status).toBe(503);\r\n            expect(response.body).toHaveProperty('status', 'error');\r\n        });\r\n\r\n        it('should handle network timeouts', async () => {\r\n            const llmService = require('../../src/services/llmService');\r\n            llmService.analyzeStatement.mockImplementationOnce(() => \r\n                new Promise((_, reject) => \r\n                    setTimeout(() => reject(new Error('Request timeout')), 100)\r\n                )\r\n            );\r\n\r\n            const response = await request(app)\r\n                .post('/api/analysis/statement')\r\n                .set('X-API-Key', API_KEY)\r\n                .attach('bankStatement', path.join(FIXTURES_PATH, 'sample-statement.pdf'));\r\n\r\n            expect(response.status).toBe(500);\r\n            expect(response.body.message).toContain('Request timeout');\r\n        });\r\n    });\r\n\r\n    describe('API Documentation and Health Check', () => {\r\n        describe('GET /api-docs', () => {\r\n            it('should serve API documentation', async () => {\r\n                const response = await request(app).get('/api-docs');\r\n                expect(response.status).toBe(200);\r\n            });\r\n        });\r\n\r\n        describe('GET /health', () => {\r\n            it('should return health status', async () => {\r\n                const response = await request(app).get('/health');\r\n                expect(response.status).toBe(200);\r\n                expect(response.body).toHaveProperty('status');\r\n            });\r\n        });\r\n    });\r\n});"],"mappings":"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","ignoreList":[]}