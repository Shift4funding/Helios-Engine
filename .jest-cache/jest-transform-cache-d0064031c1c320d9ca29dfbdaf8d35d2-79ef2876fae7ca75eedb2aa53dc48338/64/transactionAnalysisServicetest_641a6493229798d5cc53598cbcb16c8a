f50eaa71c3ef76ecbe9037d1c48a57b5
"use strict";

const {
  setupTestDatabase,
  cleanupTestDatabase
} = require('../helpers/testDb');
const TransactionAnalysisService = require('../../src/services/transactionAnalysisService');
const Transaction = require('../../src/models/Transaction');
describe('Transaction Analysis Service', () => {
  let service;
  let mockData;

  // Initialize test data and service
  beforeAll(() => {
    service = new TransactionAnalysisService();
    mockData = {
      sampleTransactions: [{
        date: new Date('2025-01-01'),
        description: 'SALARY DEPOSIT',
        amount: 5000,
        category: 'income'
      }, {
        date: new Date('2025-01-15'),
        description: 'RENT',
        amount: -2000,
        category: 'expense'
      }]
    };
  });

  // Clean up after each test
  afterEach(() => {
    jest.clearAllMocks();
  });

  // Performance metrics tests with proper isolation
  describe('performance metrics', () => {
    let mocks;
    beforeEach(() => {
      // Setup all mocks in a controlled way
      mocks = {
        hrtime: jest.spyOn(process, 'hrtime').mockImplementation(time => time ? [1, 0] : [0, 0]),
        memoryUsage: jest.spyOn(process, 'memoryUsage').mockReturnValue({
          heapUsed: 1024 * 1024
        }),
        countDocuments: jest.spyOn(Transaction, 'countDocuments').mockResolvedValue(2)
      };
    });
    afterEach(() => {
      // Restore each mock individually
      Object.values(mocks).forEach(mock => mock.mockRestore());
    });
    it('should calculate performance metrics correctly', async () => {
      // Act
      const metrics = await service.calculatePerformanceMetrics();

      // Assert structure
      expect(metrics).toMatchObject({
        processingTime: expect.any(Number),
        memoryUsage: expect.any(Number),
        transactionsProcessed: expect.any(Number)
      });

      // Assert specific values
      expect(metrics).toEqual({
        processingTime: 1,
        memoryUsage: 1024 * 1024,
        transactionsProcessed: 2
      });

      // Verify mock calls
      expect(mocks.hrtime).toHaveBeenCalledTimes(2);
      expect(mocks.memoryUsage).toHaveBeenCalledTimes(1);
      expect(mocks.countDocuments).toHaveBeenCalledTimes(1);
    });
    it('should handle database errors', async () => {
      // Arrange
      mocks.countDocuments.mockRejectedValueOnce(new Error('Database error'));

      // Act & Assert
      await expect(service.calculatePerformanceMetrics()).rejects.toThrow('Failed to calculate performance metrics');
    });
    it('should handle empty database', async () => {
      // Arrange
      mocks.countDocuments.mockResolvedValueOnce(0);

      // Act
      const metrics = await service.calculatePerformanceMetrics();

      // Assert
      expect(metrics.transactionsProcessed).toBe(0);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzZXR1cFRlc3REYXRhYmFzZSIsImNsZWFudXBUZXN0RGF0YWJhc2UiLCJyZXF1aXJlIiwiVHJhbnNhY3Rpb25BbmFseXNpc1NlcnZpY2UiLCJUcmFuc2FjdGlvbiIsImRlc2NyaWJlIiwic2VydmljZSIsIm1vY2tEYXRhIiwiYmVmb3JlQWxsIiwic2FtcGxlVHJhbnNhY3Rpb25zIiwiZGF0ZSIsIkRhdGUiLCJkZXNjcmlwdGlvbiIsImFtb3VudCIsImNhdGVnb3J5IiwiYWZ0ZXJFYWNoIiwiamVzdCIsImNsZWFyQWxsTW9ja3MiLCJtb2NrcyIsImJlZm9yZUVhY2giLCJocnRpbWUiLCJzcHlPbiIsInByb2Nlc3MiLCJtb2NrSW1wbGVtZW50YXRpb24iLCJ0aW1lIiwibWVtb3J5VXNhZ2UiLCJtb2NrUmV0dXJuVmFsdWUiLCJoZWFwVXNlZCIsImNvdW50RG9jdW1lbnRzIiwibW9ja1Jlc29sdmVkVmFsdWUiLCJPYmplY3QiLCJ2YWx1ZXMiLCJmb3JFYWNoIiwibW9jayIsIm1vY2tSZXN0b3JlIiwiaXQiLCJtZXRyaWNzIiwiY2FsY3VsYXRlUGVyZm9ybWFuY2VNZXRyaWNzIiwiZXhwZWN0IiwidG9NYXRjaE9iamVjdCIsInByb2Nlc3NpbmdUaW1lIiwiYW55IiwiTnVtYmVyIiwidHJhbnNhY3Rpb25zUHJvY2Vzc2VkIiwidG9FcXVhbCIsInRvSGF2ZUJlZW5DYWxsZWRUaW1lcyIsIm1vY2tSZWplY3RlZFZhbHVlT25jZSIsIkVycm9yIiwicmVqZWN0cyIsInRvVGhyb3ciLCJtb2NrUmVzb2x2ZWRWYWx1ZU9uY2UiLCJ0b0JlIl0sInNvdXJjZXMiOlsidHJhbnNhY3Rpb25BbmFseXNpc1NlcnZpY2UudGVzdC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IHNldHVwVGVzdERhdGFiYXNlLCBjbGVhbnVwVGVzdERhdGFiYXNlIH0gPSByZXF1aXJlKCcuLi9oZWxwZXJzL3Rlc3REYicpO1xyXG5jb25zdCBUcmFuc2FjdGlvbkFuYWx5c2lzU2VydmljZSA9IHJlcXVpcmUoJy4uLy4uL3NyYy9zZXJ2aWNlcy90cmFuc2FjdGlvbkFuYWx5c2lzU2VydmljZScpO1xyXG5jb25zdCBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3NyYy9tb2RlbHMvVHJhbnNhY3Rpb24nKTtcclxuXHJcbmRlc2NyaWJlKCdUcmFuc2FjdGlvbiBBbmFseXNpcyBTZXJ2aWNlJywgKCkgPT4ge1xyXG4gICAgbGV0IHNlcnZpY2U7XHJcbiAgICBsZXQgbW9ja0RhdGE7XHJcblxyXG4gICAgLy8gSW5pdGlhbGl6ZSB0ZXN0IGRhdGEgYW5kIHNlcnZpY2VcclxuICAgIGJlZm9yZUFsbCgoKSA9PiB7XHJcbiAgICAgICAgc2VydmljZSA9IG5ldyBUcmFuc2FjdGlvbkFuYWx5c2lzU2VydmljZSgpO1xyXG4gICAgICAgIG1vY2tEYXRhID0ge1xyXG4gICAgICAgICAgICBzYW1wbGVUcmFuc2FjdGlvbnM6IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgnMjAyNS0wMS0wMScpLFxyXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU0FMQVJZIERFUE9TSVQnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFtb3VudDogNTAwMCxcclxuICAgICAgICAgICAgICAgICAgICBjYXRlZ29yeTogJ2luY29tZSdcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0ZTogbmV3IERhdGUoJzIwMjUtMDEtMTUnKSxcclxuICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1JFTlQnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFtb3VudDogLTIwMDAsXHJcbiAgICAgICAgICAgICAgICAgICAgY2F0ZWdvcnk6ICdleHBlbnNlJ1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBdXHJcbiAgICAgICAgfTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIENsZWFuIHVwIGFmdGVyIGVhY2ggdGVzdFxyXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgICAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFBlcmZvcm1hbmNlIG1ldHJpY3MgdGVzdHMgd2l0aCBwcm9wZXIgaXNvbGF0aW9uXHJcbiAgICBkZXNjcmliZSgncGVyZm9ybWFuY2UgbWV0cmljcycsICgpID0+IHtcclxuICAgICAgICBsZXQgbW9ja3M7XHJcblxyXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBTZXR1cCBhbGwgbW9ja3MgaW4gYSBjb250cm9sbGVkIHdheVxyXG4gICAgICAgICAgICBtb2NrcyA9IHtcclxuICAgICAgICAgICAgICAgIGhydGltZTogamVzdC5zcHlPbihwcm9jZXNzLCAnaHJ0aW1lJylcclxuICAgICAgICAgICAgICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCh0aW1lKSA9PiB0aW1lID8gWzEsIDBdIDogWzAsIDBdKSxcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgbWVtb3J5VXNhZ2U6IGplc3Quc3B5T24ocHJvY2VzcywgJ21lbW9yeVVzYWdlJylcclxuICAgICAgICAgICAgICAgICAgICAubW9ja1JldHVyblZhbHVlKHsgaGVhcFVzZWQ6IDEwMjQgKiAxMDI0IH0pLFxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBjb3VudERvY3VtZW50czogamVzdC5zcHlPbihUcmFuc2FjdGlvbiwgJ2NvdW50RG9jdW1lbnRzJylcclxuICAgICAgICAgICAgICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUoMilcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgYWZ0ZXJFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgLy8gUmVzdG9yZSBlYWNoIG1vY2sgaW5kaXZpZHVhbGx5XHJcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMobW9ja3MpLmZvckVhY2gobW9jayA9PiBtb2NrLm1vY2tSZXN0b3JlKCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGNhbGN1bGF0ZSBwZXJmb3JtYW5jZSBtZXRyaWNzIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCBzZXJ2aWNlLmNhbGN1bGF0ZVBlcmZvcm1hbmNlTWV0cmljcygpO1xyXG5cclxuICAgICAgICAgICAgLy8gQXNzZXJ0IHN0cnVjdHVyZVxyXG4gICAgICAgICAgICBleHBlY3QobWV0cmljcykudG9NYXRjaE9iamVjdCh7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogZXhwZWN0LmFueShOdW1iZXIpLFxyXG4gICAgICAgICAgICAgICAgbWVtb3J5VXNhZ2U6IGV4cGVjdC5hbnkoTnVtYmVyKSxcclxuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uc1Byb2Nlc3NlZDogZXhwZWN0LmFueShOdW1iZXIpXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gQXNzZXJ0IHNwZWNpZmljIHZhbHVlc1xyXG4gICAgICAgICAgICBleHBlY3QobWV0cmljcykudG9FcXVhbCh7XHJcbiAgICAgICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogMSxcclxuICAgICAgICAgICAgICAgIG1lbW9yeVVzYWdlOiAxMDI0ICogMTAyNCxcclxuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uc1Byb2Nlc3NlZDogMlxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIFZlcmlmeSBtb2NrIGNhbGxzXHJcbiAgICAgICAgICAgIGV4cGVjdChtb2Nrcy5ocnRpbWUpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcclxuICAgICAgICAgICAgZXhwZWN0KG1vY2tzLm1lbW9yeVVzYWdlKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7XHJcbiAgICAgICAgICAgIGV4cGVjdChtb2Nrcy5jb3VudERvY3VtZW50cykudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBkYXRhYmFzZSBlcnJvcnMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICAgICAgbW9ja3MuY291bnREb2N1bWVudHMubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignRGF0YWJhc2UgZXJyb3InKSk7XHJcblxyXG4gICAgICAgICAgICAvLyBBY3QgJiBBc3NlcnRcclxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KHNlcnZpY2UuY2FsY3VsYXRlUGVyZm9ybWFuY2VNZXRyaWNzKCkpXHJcbiAgICAgICAgICAgICAgICAucmVqZWN0cy50b1Rocm93KCdGYWlsZWQgdG8gY2FsY3VsYXRlIHBlcmZvcm1hbmNlIG1ldHJpY3MnKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgZW1wdHkgZGF0YWJhc2UnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICAgICAgbW9ja3MuY291bnREb2N1bWVudHMubW9ja1Jlc29sdmVkVmFsdWVPbmNlKDApO1xyXG5cclxuICAgICAgICAgICAgLy8gQWN0XHJcbiAgICAgICAgICAgIGNvbnN0IG1ldHJpY3MgPSBhd2FpdCBzZXJ2aWNlLmNhbGN1bGF0ZVBlcmZvcm1hbmNlTWV0cmljcygpO1xyXG5cclxuICAgICAgICAgICAgLy8gQXNzZXJ0XHJcbiAgICAgICAgICAgIGV4cGVjdChtZXRyaWNzLnRyYW5zYWN0aW9uc1Byb2Nlc3NlZCkudG9CZSgwKTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTsiXSwibWFwcGluZ3MiOiI7O0FBQUEs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