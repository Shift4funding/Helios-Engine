{"version":3,"names":["_getJestObj","mock","require","jest","securityMiddleware","config","fs","promises","path","describe","mockReq","mockRes","nextFunction","beforeEach","body","test","html","params","id","$gt","query","filter","file","status","fn","mockReturnThis","json","setHeader","it","sanitizeData","expect","toBe","toHaveBeenCalled","not","toHaveProperty","req","ip","middleware","rateLimiter","i","security","rateLimit","max","toHaveBeenCalledWith","objectContaining","error","beforeAll","pdfPath","join","__dirname","pdfExists","access","then","catch","minimalPDF","writeFile","pdfBuffer","readFile","buffer","size","mimetype","validatePDF","fileMetadata","hash","toBeDefined","toMatch","Buffer","alloc","from"],"sources":["security.test.js"],"sourcesContent":["jest.mock('../../src/config/env', () => \r\n    require('../mocks/configMock')\r\n);\r\njest.mock('../../src/middleware/rateLimiter', () => \r\n    require('../mocks/redisRateLimiterMock')\r\n);\r\n\r\nconst securityMiddleware = require('../../src/middleware/security');\r\nconst config = require('../../src/config/env');\r\nconst fs = require('fs').promises;\r\nconst path = require('path');\r\n\r\ndescribe('Security Middleware', () => {\r\n    let mockReq;\r\n    let mockRes;\r\n    let nextFunction;\r\n\r\n    beforeEach(() => {\r\n        mockReq = {\r\n            body: { \r\n                test: '<script>alert(\"xss\")</script>',\r\n                html: '<p>Hello <script>bad</script></p>'\r\n            },\r\n            params: { id: { $gt: '' } },\r\n            query: { filter: '; DROP TABLE users;' },\r\n            file: null\r\n        };\r\n        mockRes = {\r\n            status: jest.fn().mockReturnThis(),\r\n            json: jest.fn(),\r\n            setHeader: jest.fn()\r\n        };\r\n        nextFunction = jest.fn();\r\n    });\r\n\r\n    describe('sanitizeData', () => {\r\n        it('should sanitize HTML and remove malicious content', () => {\r\n            securityMiddleware.sanitizeData(mockReq, mockRes, nextFunction);\r\n            \r\n            expect(mockReq.body.test).toBe('alert(\"xss\")');\r\n            expect(mockReq.body.html).toBe('Hello');\r\n            expect(nextFunction).toHaveBeenCalled();\r\n        });\r\n\r\n        it('should sanitize MongoDB injection attempts', () => {\r\n            securityMiddleware.sanitizeData(mockReq, mockRes, nextFunction);\r\n            \r\n            expect(mockReq.params.id).not.toHaveProperty('$gt');\r\n            expect(mockReq.query.filter).toBe('DROP TABLE users;');\r\n        });\r\n    });\r\n\r\n    describe('rateLimiter', () => {\r\n        it('should block excessive requests', async () => {\r\n            const req = { ip: '127.0.0.1' };\r\n            const middleware = await securityMiddleware.rateLimiter(req, mockRes, nextFunction);\r\n            \r\n            // Simulate multiple requests\r\n            for (let i = 0; i <= config.security.rateLimit.max; i++) {\r\n                await middleware(req, mockRes, nextFunction);\r\n            }\r\n            \r\n            // Verify the last request was blocked\r\n            expect(mockRes.status).toHaveBeenCalledWith(429);\r\n            expect(mockRes.json).toHaveBeenCalledWith(\r\n                expect.objectContaining({\r\n                    error: 'Too many requests'\r\n                })\r\n            );\r\n        });\r\n    });\r\n\r\n    describe('validatePDF', () => {\r\n        beforeAll(async () => {\r\n            // Create test PDF buffer\r\n            const pdfPath = path.join(__dirname, '../fixtures/test.pdf');\r\n            const pdfExists = await fs.access(pdfPath).then(() => true).catch(() => false);\r\n            \r\n            if (!pdfExists) {\r\n                // Create a minimal valid PDF for testing\r\n                const minimalPDF = '%PDF-1.4\\n%EOF';\r\n                await fs.writeFile(pdfPath, minimalPDF);\r\n            }\r\n        });\r\n\r\n        it('should validate a legitimate PDF file', async () => {\r\n            const pdfBuffer = await fs.readFile(\r\n                path.join(__dirname, '../fixtures/test.pdf')\r\n            );\r\n            mockReq.file = {\r\n                buffer: pdfBuffer,\r\n                size: 1024 * 1024,\r\n                mimetype: 'application/pdf'\r\n            };\r\n\r\n            await securityMiddleware.validatePDF(mockReq, mockRes, nextFunction);\r\n            expect(mockReq.fileMetadata.hash).toBeDefined();\r\n            expect(mockReq.fileMetadata.hash).toMatch(/^[a-f0-9]{64}$/); // SHA-256 hash format\r\n        });\r\n\r\n        it('should reject oversized files', async () => {\r\n            mockReq.file = {\r\n                buffer: Buffer.alloc(6 * 1024 * 1024),\r\n                size: 6 * 1024 * 1024,\r\n                mimetype: 'application/pdf'\r\n            };\r\n\r\n            await securityMiddleware.validatePDF(mockReq, mockRes, nextFunction);\r\n            expect(mockRes.status).toHaveBeenCalledWith(400);\r\n            expect(mockRes.json).toHaveBeenCalledWith({\r\n                error: 'File too large. Maximum size is 5MB.'\r\n            });\r\n        });\r\n\r\n        it('should reject non-PDF files', async () => {\r\n            mockReq.file = {\r\n                buffer: Buffer.from('fake image data'),\r\n                size: 1024,\r\n                mimetype: 'image/jpeg'\r\n            };\r\n\r\n            await securityMiddleware.validatePDF(mockReq, mockRes, nextFunction);\r\n            expect(mockRes.status).toHaveBeenCalledWith(400);\r\n        });\r\n    });\r\n});"],"mappings":";;AAAAA,WAAA,GAAKC,IAAI,CAAC,sBAAsB,EAAE,MAC9BC,OAAO,CAAC,qBAAqB,CACjC,CAAC;AACDF,WAAA,GAAKC,IAAI,CAAC,kCAAkC,EAAE,MAC1CC,OAAO,CAAC,+BAA+B,CAC3C,CAAC;AAAC,SAAAF,YAAA;EAAA;IAAAG;EAAA,IAAAD,OAAA;EAAAF,WAAA,GAAAA,CAAA,KAAAG,IAAA;EAAA,OAAAA,IAAA;AAAA;AAEF,MAAMC,kBAAkB,GAAGF,OAAO,CAAC,+BAA+B,CAAC;AACnE,MAAMG,MAAM,GAAGH,OAAO,CAAC,sBAAsB,CAAC;AAC9C,MAAMI,EAAE,GAAGJ,OAAO,CAAC,IAAI,CAAC,CAACK,QAAQ;AACjC,MAAMC,IAAI,GAAGN,OAAO,CAAC,MAAM,CAAC;AAE5BO,QAAQ,CAAC,qBAAqB,EAAE,MAAM;EAClC,IAAIC,OAAO;EACX,IAAIC,OAAO;EACX,IAAIC,YAAY;EAEhBC,UAAU,CAAC,MAAM;IACbH,OAAO,GAAG;MACNI,IAAI,EAAE;QACFC,IAAI,EAAE,+BAA+B;QACrCC,IAAI,EAAE;MACV,CAAC;MACDC,MAAM,EAAE;QAAEC,EAAE,EAAE;UAAEC,GAAG,EAAE;QAAG;MAAE,CAAC;MAC3BC,KAAK,EAAE;QAAEC,MAAM,EAAE;MAAsB,CAAC;MACxCC,IAAI,EAAE;IACV,CAAC;IACDX,OAAO,GAAG;MACNY,MAAM,EAAEpB,IAAI,CAACqB,EAAE,CAAC,CAAC,CAACC,cAAc,CAAC,CAAC;MAClCC,IAAI,EAAEvB,IAAI,CAACqB,EAAE,CAAC,CAAC;MACfG,SAAS,EAAExB,IAAI,CAACqB,EAAE,CAAC;IACvB,CAAC;IACDZ,YAAY,GAAGT,IAAI,CAACqB,EAAE,CAAC,CAAC;EAC5B,CAAC,CAAC;EAEFf,QAAQ,CAAC,cAAc,EAAE,MAAM;IAC3BmB,EAAE,CAAC,mDAAmD,EAAE,MAAM;MAC1DxB,kBAAkB,CAACyB,YAAY,CAACnB,OAAO,EAAEC,OAAO,EAAEC,YAAY,CAAC;MAE/DkB,MAAM,CAACpB,OAAO,CAACI,IAAI,CAACC,IAAI,CAAC,CAACgB,IAAI,CAAC,cAAc,CAAC;MAC9CD,MAAM,CAACpB,OAAO,CAACI,IAAI,CAACE,IAAI,CAAC,CAACe,IAAI,CAAC,OAAO,CAAC;MACvCD,MAAM,CAAClB,YAAY,CAAC,CAACoB,gBAAgB,CAAC,CAAC;IAC3C,CAAC,CAAC;IAEFJ,EAAE,CAAC,4CAA4C,EAAE,MAAM;MACnDxB,kBAAkB,CAACyB,YAAY,CAACnB,OAAO,EAAEC,OAAO,EAAEC,YAAY,CAAC;MAE/DkB,MAAM,CAACpB,OAAO,CAACO,MAAM,CAACC,EAAE,CAAC,CAACe,GAAG,CAACC,cAAc,CAAC,KAAK,CAAC;MACnDJ,MAAM,CAACpB,OAAO,CAACU,KAAK,CAACC,MAAM,CAAC,CAACU,IAAI,CAAC,mBAAmB,CAAC;IAC1D,CAAC,CAAC;EACN,CAAC,CAAC;EAEFtB,QAAQ,CAAC,aAAa,EAAE,MAAM;IAC1BmB,EAAE,CAAC,iCAAiC,EAAE,YAAY;MAC9C,MAAMO,GAAG,GAAG;QAAEC,EAAE,EAAE;MAAY,CAAC;MAC/B,MAAMC,UAAU,GAAG,MAAMjC,kBAAkB,CAACkC,WAAW,CAACH,GAAG,EAAExB,OAAO,EAAEC,YAAY,CAAC;;MAEnF;MACA,KAAK,IAAI2B,CAAC,GAAG,CAAC,EAAEA,CAAC,IAAIlC,MAAM,CAACmC,QAAQ,CAACC,SAAS,CAACC,GAAG,EAAEH,CAAC,EAAE,EAAE;QACrD,MAAMF,UAAU,CAACF,GAAG,EAAExB,OAAO,EAAEC,YAAY,CAAC;MAChD;;MAEA;MACAkB,MAAM,CAACnB,OAAO,CAACY,MAAM,CAAC,CAACoB,oBAAoB,CAAC,GAAG,CAAC;MAChDb,MAAM,CAACnB,OAAO,CAACe,IAAI,CAAC,CAACiB,oBAAoB,CACrCb,MAAM,CAACc,gBAAgB,CAAC;QACpBC,KAAK,EAAE;MACX,CAAC,CACL,CAAC;IACL,CAAC,CAAC;EACN,CAAC,CAAC;EAEFpC,QAAQ,CAAC,aAAa,EAAE,MAAM;IAC1BqC,SAAS,CAAC,YAAY;MAClB;MACA,MAAMC,OAAO,GAAGvC,IAAI,CAACwC,IAAI,CAACC,SAAS,EAAE,sBAAsB,CAAC;MAC5D,MAAMC,SAAS,GAAG,MAAM5C,EAAE,CAAC6C,MAAM,CAACJ,OAAO,CAAC,CAACK,IAAI,CAAC,MAAM,IAAI,CAAC,CAACC,KAAK,CAAC,MAAM,KAAK,CAAC;MAE9E,IAAI,CAACH,SAAS,EAAE;QACZ;QACA,MAAMI,UAAU,GAAG,gBAAgB;QACnC,MAAMhD,EAAE,CAACiD,SAAS,CAACR,OAAO,EAAEO,UAAU,CAAC;MAC3C;IACJ,CAAC,CAAC;IAEF1B,EAAE,CAAC,uCAAuC,EAAE,YAAY;MACpD,MAAM4B,SAAS,GAAG,MAAMlD,EAAE,CAACmD,QAAQ,CAC/BjD,IAAI,CAACwC,IAAI,CAACC,SAAS,EAAE,sBAAsB,CAC/C,CAAC;MACDvC,OAAO,CAACY,IAAI,GAAG;QACXoC,MAAM,EAAEF,SAAS;QACjBG,IAAI,EAAE,IAAI,GAAG,IAAI;QACjBC,QAAQ,EAAE;MACd,CAAC;MAED,MAAMxD,kBAAkB,CAACyD,WAAW,CAACnD,OAAO,EAAEC,OAAO,EAAEC,YAAY,CAAC;MACpEkB,MAAM,CAACpB,OAAO,CAACoD,YAAY,CAACC,IAAI,CAAC,CAACC,WAAW,CAAC,CAAC;MAC/ClC,MAAM,CAACpB,OAAO,CAACoD,YAAY,CAACC,IAAI,CAAC,CAACE,OAAO,CAAC,gBAAgB,CAAC,CAAC,CAAC;IACjE,CAAC,CAAC;IAEFrC,EAAE,CAAC,+BAA+B,EAAE,YAAY;MAC5ClB,OAAO,CAACY,IAAI,GAAG;QACXoC,MAAM,EAAEQ,MAAM,CAACC,KAAK,CAAC,CAAC,GAAG,IAAI,GAAG,IAAI,CAAC;QACrCR,IAAI,EAAE,CAAC,GAAG,IAAI,GAAG,IAAI;QACrBC,QAAQ,EAAE;MACd,CAAC;MAED,MAAMxD,kBAAkB,CAACyD,WAAW,CAACnD,OAAO,EAAEC,OAAO,EAAEC,YAAY,CAAC;MACpEkB,MAAM,CAACnB,OAAO,CAACY,MAAM,CAAC,CAACoB,oBAAoB,CAAC,GAAG,CAAC;MAChDb,MAAM,CAACnB,OAAO,CAACe,IAAI,CAAC,CAACiB,oBAAoB,CAAC;QACtCE,KAAK,EAAE;MACX,CAAC,CAAC;IACN,CAAC,CAAC;IAEFjB,EAAE,CAAC,6BAA6B,EAAE,YAAY;MAC1ClB,OAAO,CAACY,IAAI,GAAG;QACXoC,MAAM,EAAEQ,MAAM,CAACE,IAAI,CAAC,iBAAiB,CAAC;QACtCT,IAAI,EAAE,IAAI;QACVC,QAAQ,EAAE;MACd,CAAC;MAED,MAAMxD,kBAAkB,CAACyD,WAAW,CAACnD,OAAO,EAAEC,OAAO,EAAEC,YAAY,CAAC;MACpEkB,MAAM,CAACnB,OAAO,CAACY,MAAM,CAAC,CAACoB,oBAAoB,CAAC,GAAG,CAAC;IACpD,CAAC,CAAC;EACN,CAAC,CAAC;AACN,CAAC,CAAC","ignoreList":[]}