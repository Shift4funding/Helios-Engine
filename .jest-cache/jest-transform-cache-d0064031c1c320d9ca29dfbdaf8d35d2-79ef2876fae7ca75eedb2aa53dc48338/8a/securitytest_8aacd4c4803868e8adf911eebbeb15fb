7f51be6a24810c81692cba35736b693e
"use strict";

const request = require('supertest');
const express = require('express');
const {
  rateLimiter,
  validateApiKey
} = require('../../src/middleware/security');
describe('Security Middleware', () => {
  let app;
  beforeEach(() => {
    app = express();
    app.use(express.json());
  });
  describe('API Key Validation', () => {
    beforeEach(() => {
      process.env.API_KEY = 'test-api-key';
      app.use(validateApiKey);
      app.get('/test', (req, res) => res.json({
        success: true
      }));
    });
    it('should allow requests with valid API key', async () => {
      const response = await request(app).get('/test').set('X-API-Key', 'test-api-key');
      expect(response.status).toBe(200);
    });
    it('should reject requests without API key', async () => {
      const response = await request(app).get('/test');
      expect(response.status).toBe(401);
    });
  });
  describe('Rate Limiting', () => {
    beforeEach(() => {
      app.use(rateLimiter);
      app.get('/test', (req, res) => res.json({
        success: true
      }));
    });
    it('should allow requests within rate limit', async () => {
      const response = await request(app).get('/test');
      expect(response.status).toBe(200);
    });
    it('should block excessive requests', async () => {
      // Make more requests than the limit
      for (let i = 0; i < 101; i++) {
        await request(app).get('/test');
      }
      const response = await request(app).get('/test');
      expect(response.status).toBe(429);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJyZXF1ZXN0IiwicmVxdWlyZSIsImV4cHJlc3MiLCJyYXRlTGltaXRlciIsInZhbGlkYXRlQXBpS2V5IiwiZGVzY3JpYmUiLCJhcHAiLCJiZWZvcmVFYWNoIiwidXNlIiwianNvbiIsInByb2Nlc3MiLCJlbnYiLCJBUElfS0VZIiwiZ2V0IiwicmVxIiwicmVzIiwic3VjY2VzcyIsIml0IiwicmVzcG9uc2UiLCJzZXQiLCJleHBlY3QiLCJzdGF0dXMiLCJ0b0JlIiwiaSJdLCJzb3VyY2VzIjpbInNlY3VyaXR5LnRlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcmVxdWVzdCA9IHJlcXVpcmUoJ3N1cGVydGVzdCcpO1xyXG5jb25zdCBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xyXG5jb25zdCB7IHJhdGVMaW1pdGVyLCB2YWxpZGF0ZUFwaUtleSB9ID0gcmVxdWlyZSgnLi4vLi4vc3JjL21pZGRsZXdhcmUvc2VjdXJpdHknKTtcclxuXHJcbmRlc2NyaWJlKCdTZWN1cml0eSBNaWRkbGV3YXJlJywgKCkgPT4ge1xyXG4gICAgbGV0IGFwcDtcclxuXHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICBhcHAgPSBleHByZXNzKCk7XHJcbiAgICAgICAgYXBwLnVzZShleHByZXNzLmpzb24oKSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnQVBJIEtleSBWYWxpZGF0aW9uJywgKCkgPT4ge1xyXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICBwcm9jZXNzLmVudi5BUElfS0VZID0gJ3Rlc3QtYXBpLWtleSc7XHJcbiAgICAgICAgICAgIGFwcC51c2UodmFsaWRhdGVBcGlLZXkpO1xyXG4gICAgICAgICAgICBhcHAuZ2V0KCcvdGVzdCcsIChyZXEsIHJlcykgPT4gcmVzLmpzb24oeyBzdWNjZXNzOiB0cnVlIH0pKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBhbGxvdyByZXF1ZXN0cyB3aXRoIHZhbGlkIEFQSSBrZXknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgICAgICAgICAuZ2V0KCcvdGVzdCcpXHJcbiAgICAgICAgICAgICAgICAuc2V0KCdYLUFQSS1LZXknLCAndGVzdC1hcGkta2V5Jyk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KCdzaG91bGQgcmVqZWN0IHJlcXVlc3RzIHdpdGhvdXQgQVBJIGtleScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgICAgICAgICAgIC5nZXQoJy90ZXN0Jyk7XHJcblxyXG4gICAgICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBkZXNjcmliZSgnUmF0ZSBMaW1pdGluZycsICgpID0+IHtcclxuICAgICAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgYXBwLnVzZShyYXRlTGltaXRlcik7XHJcbiAgICAgICAgICAgIGFwcC5nZXQoJy90ZXN0JywgKHJlcSwgcmVzKSA9PiByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUgfSkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdCgnc2hvdWxkIGFsbG93IHJlcXVlc3RzIHdpdGhpbiByYXRlIGxpbWl0JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxyXG4gICAgICAgICAgICAgICAgLmdldCgnL3Rlc3QnKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoJ3Nob3VsZCBibG9jayBleGNlc3NpdmUgcmVxdWVzdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgICAgIC8vIE1ha2UgbW9yZSByZXF1ZXN0cyB0aGFuIHRoZSBsaW1pdFxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMTsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCByZXF1ZXN0KGFwcCkuZ2V0KCcvdGVzdCcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxyXG4gICAgICAgICAgICAgICAgLmdldCgnL3Rlc3QnKTtcclxuXHJcbiAgICAgICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDI5KTtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG59KTsiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTUEsT0FBTyxHQUFHQyxPQUFPLENBQUMsV0FBVyxDQUFDO0FBQ3BDLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLFNBQVMsQ0FBQztBQUNsQyxNQUFNO0VBQUVFLFdBQVc7RUFBRUM7QUFBZSxDQUFDLEdBQUdILE9BQU8sQ0FBQywrQkFBK0IsQ0FBQztBQUVoRkksUUFBUSxDQUFDLHFCQUFxQixFQUFFLE1BQU07RUFDbEMsSUFBSUMsR0FBRztFQUVQQyxVQUFVLENBQUMsTUFBTTtJQUNiRCxHQUFHLEdBQUdKLE9BQU8sQ0FBQyxDQUFDO0lBQ2ZJLEdBQUcsQ0FBQ0UsR0FBRyxDQUFDTixPQUFPLENBQUNPLElBQUksQ0FBQyxDQUFDLENBQUM7RUFDM0IsQ0FBQyxDQUFDO0VBRUZKLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxNQUFNO0lBQ2pDRSxVQUFVLENBQUMsTUFBTTtNQUNiRyxPQUFPLENBQUNDLEdBQUcsQ0FBQ0MsT0FBTyxHQUFHLGNBQWM7TUFDcENOLEdBQUcsQ0FBQ0UsR0FBRyxDQUFDSixjQUFjLENBQUM7TUFDdkJFLEdBQUcsQ0FBQ08sR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDQyxHQUFHLEVBQUVDLEdBQUcsS0FBS0EsR0FBRyxDQUFDTixJQUFJLENBQUM7UUFBRU8sT0FBTyxFQUFFO01BQUssQ0FBQyxDQUFDLENBQUM7SUFDL0QsQ0FBQyxDQUFDO0lBRUZDLEVBQUUsQ0FBQywwQ0FBMEMsRUFBRSxZQUFZO01BQ3ZELE1BQU1DLFFBQVEsR0FBRyxNQUFNbEIsT0FBTyxDQUFDTSxHQUFHLENBQUMsQ0FDOUJPLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FDWk0sR0FBRyxDQUFDLFdBQVcsRUFBRSxjQUFjLENBQUM7TUFFckNDLE1BQU0sQ0FBQ0YsUUFBUSxDQUFDRyxNQUFNLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNyQyxDQUFDLENBQUM7SUFFRkwsRUFBRSxDQUFDLHdDQUF3QyxFQUFFLFlBQVk7TUFDckQsTUFBTUMsUUFBUSxHQUFHLE1BQU1sQixPQUFPLENBQUNNLEdBQUcsQ0FBQyxDQUM5Qk8sR0FBRyxDQUFDLE9BQU8sQ0FBQztNQUVqQk8sTUFBTSxDQUFDRixRQUFRLENBQUNHLE1BQU0sQ0FBQyxDQUFDQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ3JDLENBQUMsQ0FBQztFQUNOLENBQUMsQ0FBQztFQUVGakIsUUFBUSxDQUFDLGVBQWUsRUFBRSxNQUFNO0lBQzVCRSxVQUFVLENBQUMsTUFBTTtNQUNiRCxHQUFHLENBQUNFLEdBQUcsQ0FBQ0wsV0FBVyxDQUFDO01BQ3BCRyxHQUFHLENBQUNPLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQ0MsR0FBRyxFQUFFQyxHQUFHLEtBQUtBLEdBQUcsQ0FBQ04sSUFBSSxDQUFDO1FBQUVPLE9BQU8sRUFBRTtNQUFLLENBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUMsQ0FBQztJQUVGQyxFQUFFLENBQUMseUNBQXlDLEVBQUUsWUFBWTtNQUN0RCxNQUFNQyxRQUFRLEdBQUcsTUFBTWxCLE9BQU8sQ0FBQ00sR0FBRyxDQUFDLENBQzlCTyxHQUFHLENBQUMsT0FBTyxDQUFDO01BRWpCTyxNQUFNLENBQUNGLFFBQVEsQ0FBQ0csTUFBTSxDQUFDLENBQUNDLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDckMsQ0FBQyxDQUFDO0lBRUZMLEVBQUUsQ0FBQyxpQ0FBaUMsRUFBRSxZQUFZO01BQzlDO01BQ0EsS0FBSyxJQUFJTSxDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUcsR0FBRyxFQUFFQSxDQUFDLEVBQUUsRUFBRTtRQUMxQixNQUFNdkIsT0FBTyxDQUFDTSxHQUFHLENBQUMsQ0FBQ08sR0FBRyxDQUFDLE9BQU8sQ0FBQztNQUNuQztNQUVBLE1BQU1LLFFBQVEsR0FBRyxNQUFNbEIsT0FBTyxDQUFDTSxHQUFHLENBQUMsQ0FDOUJPLEdBQUcsQ0FBQyxPQUFPLENBQUM7TUFFakJPLE1BQU0sQ0FBQ0YsUUFBUSxDQUFDRyxNQUFNLENBQUMsQ0FBQ0MsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNyQyxDQUFDLENBQUM7RUFDTixDQUFDLENBQUM7QUFDTixDQUFDLENBQUMiLCJpZ25vcmVMaXN0IjpbXX0=