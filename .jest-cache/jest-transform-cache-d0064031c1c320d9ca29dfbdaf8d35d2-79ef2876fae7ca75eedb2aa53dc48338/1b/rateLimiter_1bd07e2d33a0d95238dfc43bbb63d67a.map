{"version":3,"names":["Redis","require","logger","RedisRateLimiter","constructor","options","windowMs","max","keyPrefix","handler","defaultHandler","redis","host","process","env","REDIS_HOST","port","REDIS_PORT","username","REDIS_USERNAME","password","REDIS_PASSWORD","middleware","req","res","next","key","ip","current","incr","expire","rateLimit","limit","remaining","Math","resetTime","ttl","setHeader","error","status","json","retryAfter","ceil","module","exports"],"sources":["rateLimiter.js"],"sourcesContent":["const Redis = require('ioredis');\r\nconst logger = require('../config/logger');\r\n\r\nclass RedisRateLimiter {\r\n    constructor(options) {\r\n        this.windowMs = options.windowMs || 15 * 60 * 1000; // 15 minutes default\r\n        this.max = options.max || 100; // 100 requests default\r\n        this.keyPrefix = options.keyPrefix || 'rl:';\r\n        this.handler = options.handler || this.defaultHandler;\r\n        \r\n        this.redis = new Redis({\r\n            host: process.env.REDIS_HOST,\r\n            port: process.env.REDIS_PORT,\r\n            username: process.env.REDIS_USERNAME,\r\n            password: process.env.REDIS_PASSWORD\r\n        });\r\n    }\r\n\r\n    async middleware() {\r\n        return async (req, res, next) => {\r\n            try {\r\n                const key = this.keyPrefix + req.ip;\r\n                const current = await this.redis.incr(key);\r\n\r\n                if (current === 1) {\r\n                    await this.redis.expire(key, this.windowMs / 1000);\r\n                }\r\n\r\n                req.rateLimit = {\r\n                    limit: this.max,\r\n                    current: current,\r\n                    remaining: Math.max(0, this.max - current),\r\n                    resetTime: await this.redis.ttl(key) * 1000\r\n                };\r\n\r\n                res.setHeader('X-RateLimit-Limit', this.max);\r\n                res.setHeader('X-RateLimit-Remaining', req.rateLimit.remaining);\r\n                res.setHeader('X-RateLimit-Reset', req.rateLimit.resetTime);\r\n\r\n                if (current > this.max) {\r\n                    return this.handler(req, res);\r\n                }\r\n\r\n                next();\r\n            } catch (error) {\r\n                logger.error('Rate limiter error:', error);\r\n                next();\r\n            }\r\n        };\r\n    }\r\n\r\n    defaultHandler(req, res) {\r\n        res.status(429).json({\r\n            error: 'Too many requests, please try again later.',\r\n            retryAfter: Math.ceil(req.rateLimit.resetTime / 1000)\r\n        });\r\n    }\r\n}\r\n\r\nmodule.exports = RedisRateLimiter;"],"mappings":";;AAAA,MAAMA,KAAK,GAAGC,OAAO,CAAC,SAAS,CAAC;AAChC,MAAMC,MAAM,GAAGD,OAAO,CAAC,kBAAkB,CAAC;AAE1C,MAAME,gBAAgB,CAAC;EACnBC,WAAWA,CAACC,OAAO,EAAE;IACjB,IAAI,CAACC,QAAQ,GAAGD,OAAO,CAACC,QAAQ,IAAI,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC;IACpD,IAAI,CAACC,GAAG,GAAGF,OAAO,CAACE,GAAG,IAAI,GAAG,CAAC,CAAC;IAC/B,IAAI,CAACC,SAAS,GAAGH,OAAO,CAACG,SAAS,IAAI,KAAK;IAC3C,IAAI,CAACC,OAAO,GAAGJ,OAAO,CAACI,OAAO,IAAI,IAAI,CAACC,cAAc;IAErD,IAAI,CAACC,KAAK,GAAG,IAAIX,KAAK,CAAC;MACnBY,IAAI,EAAEC,OAAO,CAACC,GAAG,CAACC,UAAU;MAC5BC,IAAI,EAAEH,OAAO,CAACC,GAAG,CAACG,UAAU;MAC5BC,QAAQ,EAAEL,OAAO,CAACC,GAAG,CAACK,cAAc;MACpCC,QAAQ,EAAEP,OAAO,CAACC,GAAG,CAACO;IAC1B,CAAC,CAAC;EACN;EAEA,MAAMC,UAAUA,CAAA,EAAG;IACf,OAAO,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;MAC7B,IAAI;QACA,MAAMC,GAAG,GAAG,IAAI,CAAClB,SAAS,GAAGe,GAAG,CAACI,EAAE;QACnC,MAAMC,OAAO,GAAG,MAAM,IAAI,CAACjB,KAAK,CAACkB,IAAI,CAACH,GAAG,CAAC;QAE1C,IAAIE,OAAO,KAAK,CAAC,EAAE;UACf,MAAM,IAAI,CAACjB,KAAK,CAACmB,MAAM,CAACJ,GAAG,EAAE,IAAI,CAACpB,QAAQ,GAAG,IAAI,CAAC;QACtD;QAEAiB,GAAG,CAACQ,SAAS,GAAG;UACZC,KAAK,EAAE,IAAI,CAACzB,GAAG;UACfqB,OAAO,EAAEA,OAAO;UAChBK,SAAS,EAAEC,IAAI,CAAC3B,GAAG,CAAC,CAAC,EAAE,IAAI,CAACA,GAAG,GAAGqB,OAAO,CAAC;UAC1CO,SAAS,EAAE,OAAM,IAAI,CAACxB,KAAK,CAACyB,GAAG,CAACV,GAAG,CAAC,IAAG;QAC3C,CAAC;QAEDF,GAAG,CAACa,SAAS,CAAC,mBAAmB,EAAE,IAAI,CAAC9B,GAAG,CAAC;QAC5CiB,GAAG,CAACa,SAAS,CAAC,uBAAuB,EAAEd,GAAG,CAACQ,SAAS,CAACE,SAAS,CAAC;QAC/DT,GAAG,CAACa,SAAS,CAAC,mBAAmB,EAAEd,GAAG,CAACQ,SAAS,CAACI,SAAS,CAAC;QAE3D,IAAIP,OAAO,GAAG,IAAI,CAACrB,GAAG,EAAE;UACpB,OAAO,IAAI,CAACE,OAAO,CAACc,GAAG,EAAEC,GAAG,CAAC;QACjC;QAEAC,IAAI,CAAC,CAAC;MACV,CAAC,CAAC,OAAOa,KAAK,EAAE;QACZpC,MAAM,CAACoC,KAAK,CAAC,qBAAqB,EAAEA,KAAK,CAAC;QAC1Cb,IAAI,CAAC,CAAC;MACV;IACJ,CAAC;EACL;EAEAf,cAAcA,CAACa,GAAG,EAAEC,GAAG,EAAE;IACrBA,GAAG,CAACe,MAAM,CAAC,GAAG,CAAC,CAACC,IAAI,CAAC;MACjBF,KAAK,EAAE,4CAA4C;MACnDG,UAAU,EAAEP,IAAI,CAACQ,IAAI,CAACnB,GAAG,CAACQ,SAAS,CAACI,SAAS,GAAG,IAAI;IACxD,CAAC,CAAC;EACN;AACJ;AAEAQ,MAAM,CAACC,OAAO,GAAGzC,gBAAgB","ignoreList":[]}