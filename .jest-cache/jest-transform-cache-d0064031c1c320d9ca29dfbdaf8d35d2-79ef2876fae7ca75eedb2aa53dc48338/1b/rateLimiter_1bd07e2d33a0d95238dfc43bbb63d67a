71c7bcf938dfea75cc75deabd38bce1a
"use strict";

const Redis = require('ioredis');
const logger = require('../config/logger');
class RedisRateLimiter {
  constructor(options) {
    this.windowMs = options.windowMs || 15 * 60 * 1000; // 15 minutes default
    this.max = options.max || 100; // 100 requests default
    this.keyPrefix = options.keyPrefix || 'rl:';
    this.handler = options.handler || this.defaultHandler;
    this.redis = new Redis({
      host: process.env.REDIS_HOST,
      port: process.env.REDIS_PORT,
      username: process.env.REDIS_USERNAME,
      password: process.env.REDIS_PASSWORD
    });
  }
  async middleware() {
    return async (req, res, next) => {
      try {
        const key = this.keyPrefix + req.ip;
        const current = await this.redis.incr(key);
        if (current === 1) {
          await this.redis.expire(key, this.windowMs / 1000);
        }
        req.rateLimit = {
          limit: this.max,
          current: current,
          remaining: Math.max(0, this.max - current),
          resetTime: (await this.redis.ttl(key)) * 1000
        };
        res.setHeader('X-RateLimit-Limit', this.max);
        res.setHeader('X-RateLimit-Remaining', req.rateLimit.remaining);
        res.setHeader('X-RateLimit-Reset', req.rateLimit.resetTime);
        if (current > this.max) {
          return this.handler(req, res);
        }
        next();
      } catch (error) {
        logger.error('Rate limiter error:', error);
        next();
      }
    };
  }
  defaultHandler(req, res) {
    res.status(429).json({
      error: 'Too many requests, please try again later.',
      retryAfter: Math.ceil(req.rateLimit.resetTime / 1000)
    });
  }
}
module.exports = RedisRateLimiter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJSZWRpcyIsInJlcXVpcmUiLCJsb2dnZXIiLCJSZWRpc1JhdGVMaW1pdGVyIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwid2luZG93TXMiLCJtYXgiLCJrZXlQcmVmaXgiLCJoYW5kbGVyIiwiZGVmYXVsdEhhbmRsZXIiLCJyZWRpcyIsImhvc3QiLCJwcm9jZXNzIiwiZW52IiwiUkVESVNfSE9TVCIsInBvcnQiLCJSRURJU19QT1JUIiwidXNlcm5hbWUiLCJSRURJU19VU0VSTkFNRSIsInBhc3N3b3JkIiwiUkVESVNfUEFTU1dPUkQiLCJtaWRkbGV3YXJlIiwicmVxIiwicmVzIiwibmV4dCIsImtleSIsImlwIiwiY3VycmVudCIsImluY3IiLCJleHBpcmUiLCJyYXRlTGltaXQiLCJsaW1pdCIsInJlbWFpbmluZyIsIk1hdGgiLCJyZXNldFRpbWUiLCJ0dGwiLCJzZXRIZWFkZXIiLCJlcnJvciIsInN0YXR1cyIsImpzb24iLCJyZXRyeUFmdGVyIiwiY2VpbCIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJyYXRlTGltaXRlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBSZWRpcyA9IHJlcXVpcmUoJ2lvcmVkaXMnKTtcclxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnLi4vY29uZmlnL2xvZ2dlcicpO1xyXG5cclxuY2xhc3MgUmVkaXNSYXRlTGltaXRlciB7XHJcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy53aW5kb3dNcyA9IG9wdGlvbnMud2luZG93TXMgfHwgMTUgKiA2MCAqIDEwMDA7IC8vIDE1IG1pbnV0ZXMgZGVmYXVsdFxyXG4gICAgICAgIHRoaXMubWF4ID0gb3B0aW9ucy5tYXggfHwgMTAwOyAvLyAxMDAgcmVxdWVzdHMgZGVmYXVsdFxyXG4gICAgICAgIHRoaXMua2V5UHJlZml4ID0gb3B0aW9ucy5rZXlQcmVmaXggfHwgJ3JsOic7XHJcbiAgICAgICAgdGhpcy5oYW5kbGVyID0gb3B0aW9ucy5oYW5kbGVyIHx8IHRoaXMuZGVmYXVsdEhhbmRsZXI7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5yZWRpcyA9IG5ldyBSZWRpcyh7XHJcbiAgICAgICAgICAgIGhvc3Q6IHByb2Nlc3MuZW52LlJFRElTX0hPU1QsXHJcbiAgICAgICAgICAgIHBvcnQ6IHByb2Nlc3MuZW52LlJFRElTX1BPUlQsXHJcbiAgICAgICAgICAgIHVzZXJuYW1lOiBwcm9jZXNzLmVudi5SRURJU19VU0VSTkFNRSxcclxuICAgICAgICAgICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlJFRElTX1BBU1NXT1JEXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgbWlkZGxld2FyZSgpIHtcclxuICAgICAgICByZXR1cm4gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSB0aGlzLmtleVByZWZpeCArIHJlcS5pcDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBhd2FpdCB0aGlzLnJlZGlzLmluY3Ioa2V5KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVkaXMuZXhwaXJlKGtleSwgdGhpcy53aW5kb3dNcyAvIDEwMDApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJlcS5yYXRlTGltaXQgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGltaXQ6IHRoaXMubWF4LFxyXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQ6IGN1cnJlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nOiBNYXRoLm1heCgwLCB0aGlzLm1heCAtIGN1cnJlbnQpLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlc2V0VGltZTogYXdhaXQgdGhpcy5yZWRpcy50dGwoa2V5KSAqIDEwMDBcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICAgICAgcmVzLnNldEhlYWRlcignWC1SYXRlTGltaXQtTGltaXQnLCB0aGlzLm1heCk7XHJcbiAgICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZW1haW5pbmcnLCByZXEucmF0ZUxpbWl0LnJlbWFpbmluZyk7XHJcbiAgICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIHJlcS5yYXRlTGltaXQucmVzZXRUaW1lKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA+IHRoaXMubWF4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlcihyZXEsIHJlcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgbmV4dCgpO1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCdSYXRlIGxpbWl0ZXIgZXJyb3I6JywgZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgbmV4dCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBkZWZhdWx0SGFuZGxlcihyZXEsIHJlcykge1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNDI5KS5qc29uKHtcclxuICAgICAgICAgICAgZXJyb3I6ICdUb28gbWFueSByZXF1ZXN0cywgcGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxyXG4gICAgICAgICAgICByZXRyeUFmdGVyOiBNYXRoLmNlaWwocmVxLnJhdGVMaW1pdC5yZXNldFRpbWUgLyAxMDAwKVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IFJlZGlzUmF0ZUxpbWl0ZXI7Il0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEtBQUss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